---
title: "Exploring the Assimilative Capacity of Old Tampa Bay"
author: "Tampa Bay Estuary Program"
date: "`r Sys.Date()`"
format:
  html:
    theme: cosmo
    code-tools: 
      source: https://github.com/tbep-tech/explore-ass-cap/blob/main/docs/explore.qmd
    css: styles.css
toc: true
lightbox: true
execute:
  echo: false
  warning: false
---

```{r}
#| include: false
library(tidyverse)
library(here)
library(patchwork)
library(GGally)

source(here('R/funcs.R'))

data(epcdata, package = 'tbeptools')
load(file = here('data/lddat.RData'))

# bay segment chl aves
wqmo <- tbeptools::anlz_avedat(epcdata)$mos |>
  filter(var == 'mean_chla') |>
  rename(chla = val) |>
  select(-var) |>
  mutate(
    date = make_date(yr, mo, day = 1)
  ) |>
  filter(yr >= 2000)

# join and create up to six month lags for tn_load
tomod <- inner_join(wqmo, lddat, by = c('bay_segment', 'date', 'yr', 'mo')) |>
  mutate(
    tn_load_lag1 = lag(tn_load, 1),
    tn_load_lag2 = lag(tn_load, 2),
    tn_load_lag3 = lag(tn_load, 3),
    tn_load_lag4 = lag(tn_load, 4),
    tn_load_lag5 = lag(tn_load, 5),
    tn_load_lag6 = lag(tn_load, 6),
    .by = bay_segment
  ) |>
  group_by(bay_segment) |>
  fill(tn_load_lag1:tn_load_lag6, .direction = 'up') |>
  ungroup() |>
  rename(tn_load_lag0 = tn_load) |>
  mutate(
    tn_load_lag1 = rowSums(pick(tn_load_lag0:tn_load_lag1), na.rm = FALSE),
    tn_load_lag2 = rowSums(pick(tn_load_lag0:tn_load_lag2), na.rm = FALSE),
    tn_load_lag3 = rowSums(pick(tn_load_lag0:tn_load_lag3), na.rm = FALSE),
    tn_load_lag4 = rowSums(pick(tn_load_lag0:tn_load_lag4), na.rm = FALSE),
    tn_load_lag5 = rowSums(pick(tn_load_lag0:tn_load_lag5), na.rm = FALSE),
    tn_load_lag6 = rowSums(pick(tn_load_lag0:tn_load_lag6), na.rm = FALSE)
  ) |>
  pivot_longer(
    cols = starts_with('tn_load_lag'),
    names_to = 'lag',
    values_to = 'tn_load'
  ) |>
  mutate(
    lag = str_remove(lag, 'tn_load_'),
    lag = str_replace(lag, 'lag', 'Lag ')
  )
```

## Original Model, All Bay Segments 

The cumulative lag model from [Janicki and Wade 1996](https://drive.google.com/file/d/1kZkvuprvsMyN9nPS5PHYvXHyo1KQxKTr/view) is specified as:

$$
\text{chla}_{t, s} = \alpha_{t, s} + \beta_s \left( \Sigma_{i = I_0}^{I_n} L_{t - i, s} \right)
$$

where $\text{chla}_{t, s}$ is the chlorophyll-a concentration at month $t$ and bay segment $s$, $\alpha_{t, s}$ is the intercept term that varies by $t$ and $s$, $\beta_s$ is the coefficient for the cumulative load term that varies by $s$, and $L_{t - 1, s}$ is the cumulative nitrogen nitrogen load evaluated at different lags from $I_0$ as the present month in the time series to $I_n$ months for each $s$.

Models are created with the following linear model structure in  R, where the `tn_load` variable is the cumulative lag load for different $n$ lags.

```{r}
#| eval: false
#| echo: true
chla ~ factor(bay_segment):factor(mo) + tn_load:factor(bay_segment)
```

```{r}
#| fig-height: 2
# create scatterplots of chla vs tn_load with linear fits for each lag
lagplo_fun(tomod, '2000 to 2024', '#F8766D')
```

```{r}
#| fig-height: 2
mod <- tomod |>
  group_nest(lag) |>
  mutate(
    model = map(data, function(x) {
      mod <- lm(
        chla ~ factor(bay_segment):factor(mo) + tn_load:factor(bay_segment),
        data = x
      )

      # get rsq for all
      rsq <- summary(mod)$r.squared

      tibble(
        rsq = rsq,
      )
    })
  ) |>
  select(-data) |>
  unnest(model) |>
  pivot_longer(
    cols = starts_with('rsq'),
    names_to = 'period',
    values_to = 'rsq'
  ) |>
  mutate(
    lag = str_remove(lag, 'Lag ')
  )

rsqplo_fun(mod)
```

## OTB Only Model

The models are the same as above except the bay segment term is removed since only OTB is being modeled.

The cumulative lag model from is specified as:

$$
\text{chla}_{t} = \alpha_{t} + \beta \left( \Sigma_{i = I_0}^{I_n} L_{t - i} \right)
$$

where $\text{chla}_{t}$ is the chlorophyll-a concentration at month $t$, $\alpha_{t}$ is the intercept term that varies by $t$, $\beta$ is the coefficient for the cumulative load term, and $L_{t - i}$ is the cumulative nitrogen load evaluated at different lags from $I_0$ for the present month to $I_n$ months.

Models are run with the following linear model structure in  R, where the `tn_load` variable is the cumulative lag load for different $n$ lags.

```{r}
#| eval: false
#| echo: true
chla ~ factor(mo) + tn_load
```

```{r}
#| fig-height: 2
tomodotb <- tomod |>
  filter(bay_segment %in% 'OTB')

# create scatterplots of chla vs tn_load with linear fits for each lag
lagplo_fun(tomodotb, '2000 to 2024', '#F8766D')
```

```{r}
#| fig-height: 2
mod <- tomodotb |>
  group_nest(lag) |>
  mutate(
    model = map(data, function(x) {
      mod <- lm(
        chla ~ factor(mo) + tn_load,
        data = x
      )
      # get rsq for all
      rsq <- summary(mod)$r.squared

      tibble(
        rsq = rsq
      )
    })
  ) |>
  select(-data) |>
  unnest(model) |>
  pivot_longer(
    cols = starts_with('rsq'),
    values_to = 'rsq'
  ) |>
  mutate(
    lag = str_remove(lag, 'Lag ')
  )

rsqplo_fun(mod)
```

## Assimilative Capacity Analysis

The cumulative lag model with a 3-month lag was chosen for the assimilative capacity analysis based on the results above and previous work by Janicki and Wade (1996).

```{r}
toprdotb <- tomodotb |>
  pivot_wider(
    names_from = lag,
    values_from = tn_load
  ) |>
  nest() |>
  mutate(
    model = map(data, function(x) {
      lm(
        chla ~ factor(mo) + `Lag 3`,
        data = x,
        na.action = 'na.exclude'
      )
    }),
    pred = map2(model, data, function(mod, dat) {
      predict(mod, newdata = dat)
    })
  )

toplo <- toprdotb |>
  select(-model) |>
  unnest(c(data, pred))

ggplot(toplo, aes(x = date, y = chla)) +
  geom_point() +
  geom_line(aes(y = pred), color = 'cornflowerblue') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Monthly Observed and Predicted Chlorophyll-a in Old Tampa Bay',
    y = 'µg/L',
    x = NULL
  )
```

The annual average observed and predicted chlorophyll-a concentrations are compared for Old Tampa Bay below.

```{r}
annavg <- tbeptools::anlz_avedat(epcdata)$ann |>
  filter(bay_segment %in% 'OTB', var == 'mean_chla') |>
  filter(yr >= 2000)

modestavg <- toplo |>
  summarize(
    predchla = mean(pred, na.rm = TRUE),
    .by = c(yr)
  )

ggplot(annavg, aes(x = yr, y = val)) +
  geom_line(aes(color = 'Observed')) +
  geom_point(aes(color = 'Observed'), size = 3) +
  geom_line(data = modestavg, aes(x = yr, y = predchla, color = 'Predicted')) +
  geom_point(
    data = modestavg,
    aes(x = yr, y = predchla, color = 'Predicted'),
    size = 3
  ) +
  scale_color_manual(
    values = c('Observed' = 'black', 'Predicted' = 'cornflowerblue')
  ) +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  guides(color = guide_legend(override.aes = list(shape = NA))) +
  labs(
    title = 'Annual Average Observed and Predicted Chlorophyll-a in Old Tampa Bay',
    y = 'µg/L',
    x = 'Year',
    color = NULL
  )
```

The assimilative capacity analysis involves simulating various nitrogen load reduction scenarios and predicting the resulting chlorophyll-a concentrations using the developed models. Monthly loads are reduced by fractions ranging from 0% to 100% in 5% increments. The models are then used to predict chlorophyll-a concentrations under each load reduction scenario.

```{r}
#| fig-height: 3
# load reduction scenarios
redscn <- crossing(
  redscn = seq(0, 1, by = 0.05),
  lddat |>
    filter(bay_segment %in% 'OTB') |>
    filter(yr >= 2000)
) |>
  group_nest(redscn) |>
  mutate(
    data = pmap(list(redscn, data), function(red, dat) {
      dat |>
        mutate(
          tn_load_lag0 = tn_load * red,
          tn_load_lag1 = lag(tn_load_lag0, 1),
          tn_load_lag2 = lag(tn_load_lag0, 2),
          tn_load_lag3 = lag(tn_load_lag0, 3)
        ) |>
        fill(tn_load_lag1:tn_load_lag3, .direction = 'up') |>
        mutate(
          tn_load_lag1 = rowSums(
            pick(tn_load_lag0:tn_load_lag1),
            na.rm = FALSE
          ),
          tn_load_lag2 = rowSums(
            pick(tn_load_lag0:tn_load_lag2),
            na.rm = FALSE
          ),
          tn_load_lag3 = rowSums(pick(tn_load_lag0:tn_load_lag3), na.rm = FALSE)
        ) |>
        rename(`Lag 3` = tn_load_lag3)
    }),
    data = map(data, function(dat) {
      mod <- toprdotb |> pull(model)
      prd <- predict(
        mod[[1]],
        newdata = dat,
      )
      bind_cols(dat, tibble(predchla = prd))
    }),
    annavg = map(data, function(dat) {
      dat |>
        summarize(
          tn_load = sum(tn_load_lag0, na.rm = TRUE),
          predchla = mean(predchla, na.rm = TRUE),
          .by = yr
        )
    })
  )

toplo <- redscn |>
  select(redscn, data) |>
  unnest(data)

ggplot(toplo, aes(x = date, y = tn_load_lag0)) +
  geom_line(aes(group = redscn, color = redscn)) +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'D') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Monthly Load Reduction Scenarios',
    y = 'tons/month',
    x = NULL
  )

ggplot(toplo, aes(x = date, y = predchla)) +
  geom_line(aes(group = redscn, color = redscn)) +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'C') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Monthly Predicted Chlorophyll-a Under Load Reduction Scenarios',
    y = 'µg/L',
    x = NULL
  )
```

Monthly  model predictions are then aggregated to annual average predicted chlorophyll-a and total nitrogen loads for each load reduction scenario.

```{r}
#| fig-height: 3
toplo2 <- redscn |>
  select(redscn, annavg) |>
  unnest(annavg)

ggplot(toplo2, aes(x = yr, y = tn_load, group = redscn)) +
  geom_line(aes(color = redscn)) +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'D') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Annual Total Nitrogen Loads from Monthly Reduction Scenarios',
    y = 'tons/year',
    x = NULL
  )

ggplot(toplo2, aes(x = yr, y = predchla, group = redscn)) +
  geom_line(aes(color = redscn)) +
  geom_hline(yintercept = 8.5, linetype = 'dashed', color = 'red') +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'C') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Annual Average Predicted Chlorophyll-a Under Load Reduction Scenarios',
    y = 'µg/L',
    x = NULL
  )
```

```{r}
toplo3 <- toplo2 |>
  summarise(
    avechl = mean(predchla, na.rm = TRUE),
    tn_load = mean(tn_load, na.rm = TRUE),
    .by = c(redscn)
  )

# get the x-axis load values for 8.5 ug/L chl-a
asscap <- lm(
  avechl ~ tn_load,
  data = toplo3
) |>
  coefficients()
asscap <- (8.5 - asscap[1]) / asscap[2]

addlns <- tibble(
  avechl = 8.5,
  tn_load = asscap
)
```

The average response of chlorophyll-a to nitrogen load changes was then estimated by taking the average of the annual chlorophyll predictions and the average load estimates for each reduction scenario.  The plots below show each point as the average predicted chlorophyll-a versus the average total nitrogen load for each load reduction scenario.  The dashed red line indicates the target chlorophyll-a concentration of 8.5 µg/L.  The arrow indicates the estimated nitrogen load reductions needed to achieve the target chlorophyll-a concentration based on linear interpolation of the average response curves. The estimated loads needed to achieve 8.5 µg/L chlorophyll-a are `r round(asscap, 0)` tons/year.

```{r}
ggplot(toplo3, aes(x = tn_load, y = avechl)) +
  geom_line() +
  geom_point() +
  geom_segment(
    data = addlns,
    aes(
      x = tn_load,
      y = avechl,
      xend = tn_load,
      yend = 0
    ),
    arrow = arrow(length = unit(0.6, "cm")),
    linetype = 'solid',
  ) +
  geom_text(
    data = addlns,
    aes(
      x = tn_load,
      y = 0,
      label = paste0(
        'Estimated load at 8.5 µg/L: ',
        round(tn_load, 0),
        ' tons/yr'
      )
    ),
    hjust = 1.05,
    vjust = 0,
    size = 3,
    fontface = 'bold'
  ) +
  geom_hline(yintercept = 8.5, linetype = 'dashed', color = 'red') +
  theme_minimal() +
  theme(
    legend.position = 'none'
  ) +
  labs(
    title = 'Average Predicted Chlorophyll-a vs. Average Nitrogen\nLoad Under Load Reduction Scenarios',
    y = 'µg/L',
    x = 'tons/yr',
  )
```

## Log-models with additional predictors

The above models used to predict the assimilative capacity of Old Tampa Bay, particularly for the period after 2010, likely provide an overestimate of how much loading the bay segment can assimilate.  This is evident by evaluating the residual patterns - the model does not capture extreme values.  Results could be improved by modeling an inherently log-normal response variable and including additional predictors to provide a more accurate estimate of how nitrogen load influences chlorophyll-a.

```{r}
mod <- toprdotb$model[[1]]
ggplot(data.frame(residuals = residuals(mod)), aes(sample = residuals)) +
  stat_qq() +
  stat_qq_line(color = 'red') +
  labs(
    title = "Normal Q-Q Plot of Residuals from the OTB Model",
    x = "Theoretical Quantiles",
    y = "Sample Quantiles"
  ) +
  theme_minimal()
```

To address this issue, an additional model was developed using log-transformed chlorophyll-a as the response variable and additional predictors, including salinity and temperature. 

```{r}
newdat <- epcdata |>
  filter(
    bay_segment %in% 'OTB'
  ) |>
  mutate(
    date = make_date(yr, mo, day = 1)
  ) |>
  summarise(
    sal = mean(Sal_Top_ppth, na.rm = T),
    temp = mean(Temp_Water_Top_degC, na.rm = T),
    .by = c(bay_segment, date, yr, mo)
  ) |>
  inner_join(wqmo, by = c('bay_segment', 'date', 'yr', 'mo')) |>
  inner_join(lddat, by = c('bay_segment', 'date', 'yr', 'mo')) |>
  arrange(date)

toplo <- newdat |>
  select(chla, sal, temp, tn_load) |>
  mutate(
    chla = log10(chla),
    tn_load = log10(tn_load)
  )

ggpairs(toplo)
```

Collinearity among the new predictors was assessed using variance inflation factors (VIFs), where chlorophyll and load are log-transformed.  The values are sufficiently low to include all predictors in the model.

```{r}
# check vif
mod <- lm(
  chla ~ sal + temp + tn_load,
  data = toplo
)
car::vif(mod)
```

The above analyses were repeated with the following changes to the model structure:

$$
log_{10}\text{chla}_{t} = \alpha_{t} + \beta_1 log_{10}\left( \Sigma_{i = I_0}^{I_n} L_{t - i} \right) + \beta_2 \text{sal}_{t} + \beta_3 \text{temp}_{t}
$$

where the coefficients $\beta_2$ and $\beta_3$ represent the influence of salinity and temperature on chlorophyll-a concentrations.  Chlorophyll is modelled using a log-normal distribution to better capture extreme values and loading is also log-transformed. Below shows the explained deviance (pseudo-r-squared) for each cumulative lag model.

```{r}
#| fig-height: 2
# create up to six month lags for tn_load
newtomod <- newdat |>
  mutate(
    tn_load_lag1 = lag(tn_load, 1),
    tn_load_lag2 = lag(tn_load, 2),
    tn_load_lag3 = lag(tn_load, 3),
    tn_load_lag4 = lag(tn_load, 4),
    tn_load_lag5 = lag(tn_load, 5),
    tn_load_lag6 = lag(tn_load, 6),
    .by = bay_segment
  ) |>
  rename(tn_load_lag0 = tn_load) |>
  fill(tn_load_lag1:tn_load_lag6, .direction = 'up') |>
  mutate(
    tn_load_lag1 = rowSums(pick(tn_load_lag0:tn_load_lag1), na.rm = FALSE),
    tn_load_lag2 = rowSums(pick(tn_load_lag0:tn_load_lag2), na.rm = FALSE),
    tn_load_lag3 = rowSums(pick(tn_load_lag0:tn_load_lag3), na.rm = FALSE),
    tn_load_lag4 = rowSums(pick(tn_load_lag0:tn_load_lag4), na.rm = FALSE),
    tn_load_lag5 = rowSums(pick(tn_load_lag0:tn_load_lag5), na.rm = FALSE),
    tn_load_lag6 = rowSums(pick(tn_load_lag0:tn_load_lag6), na.rm = FALSE)
  ) |>
  pivot_longer(
    cols = starts_with('tn_load_lag'),
    names_to = 'lag',
    values_to = 'tn_load'
  ) |>
  mutate(
    lag = str_remove(lag, 'tn_load_'),
    lag = str_replace(lag, 'lag', 'Lag ')
  )

mod <- newtomod |>
  group_nest(lag) |>
  mutate(
    model = map(data, function(x) {
      mod <- glm(
        chla ~ factor(mo) + log10(1 + tn_load) + sal + temp,
        family = gaussian(link = 'log'),
        data = x
      )

      # get rsq for all
      rsq <- 1 - (mod$deviance / mod$null.deviance)

      tibble(
        rsq = rsq
      )
    })
  ) |>
  select(-data) |>
  unnest(model) |>
  pivot_longer(
    cols = starts_with('rsq'),
    names_to = 'period',
    values_to = 'rsq'
  ) |>
  mutate(
    lag = str_remove(lag, 'Lag ')
  )

rsqplo_fun(mod)
```

The monthly observed and predicted chlorophyll-a concentrations are compared for Old Tampa Bay below.

```{r}
newtoprd <- newtomod |>
  pivot_wider(
    names_from = lag,
    values_from = tn_load
  ) |>
  nest() |>
  mutate(
    model = map(data, function(x) {
      glm(
        chla ~ factor(mo) + log10(1 + `Lag 3`) + sal + temp,
        data = x,
        family = gaussian(link = 'log'),
        na.action = 'na.exclude'
      )
    }),
    pred = map2(model, data, function(mod, dat) {
      predict(mod, newdata = dat, type = 'response')
    })
  )

toplo <- newtoprd |>
  select(-model) |>
  unnest(c(data, pred))

ggplot(toplo, aes(x = date, y = chla)) +
  geom_point() +
  geom_line(aes(y = pred)) +
  # geom_hline(yintercept = 9.3, linetype = 'dashed', color = 'red') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Monthly Observed and Predicted Chlorophyll-a in Old Tampa Bay',
    y = 'µg/L',
    x = NULL,
    color = 'Model'
  )
```

The annual average observed and predicted chlorophyll-a concentrations are compared for Old Tampa Bay below.

```{r}
annavg <- tbeptools::anlz_avedat(epcdata)$ann |>
  filter(bay_segment %in% 'OTB', var == 'mean_chla') |>
  filter(yr >= 2000)

modestavg <- toplo |>
  summarize(
    predchla = mean(pred, na.rm = TRUE),
    .by = c(yr)
  )

ggplot(annavg, aes(x = yr, y = val)) +
  geom_line(aes(color = 'Observed')) +
  geom_point(aes(color = 'Observed'), size = 3) +
  geom_line(data = modestavg, aes(x = yr, y = predchla, color = 'Predicted')) +
  geom_point(
    data = modestavg,
    aes(x = yr, y = predchla, color = 'Predicted'),
    size = 3
  ) +
  scale_color_manual(
    values = c('Observed' = 'black', 'Predicted' = 'cornflowerblue')
  ) +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  guides(color = guide_legend(override.aes = list(shape = NA))) +
  labs(
    title = 'Annual Average Observed and Predicted Chlorophyll-a in Old Tampa Bay',
    y = 'µg/L',
    x = 'Year',
    color = NULL
  )
```

Monthly and annual model predictions are then generated for various nitrogen load reduction scenarios using the new log-model with additional predictors. Monthly loads are reduced by fractions ranging from 0% to 100% in 5% increments. The models are then used to predict chlorophyll-a concentrations under each load reduction scenario.  __Salinity and temperature are held constant at their monthly average values for each month across the entire time series.__

```{r}
#| fig-height: 3
redscn <- crossing(
  redscn = seq(0, 1, by = 0.05), #10^(seq(log10(0.001), log10(1), length.out = 10)),
  newdat
) |>
  group_nest(redscn) |>
  mutate(
    data = pmap(list(redscn, data), function(red, dat) {
      dat |>
        mutate(
          tn_load_lag0 = tn_load * red,
          tn_load_lag1 = lag(tn_load_lag0, 1),
          tn_load_lag2 = lag(tn_load_lag0, 2),
          tn_load_lag3 = lag(tn_load_lag0, 3)
        ) |>
        fill(tn_load_lag1:tn_load_lag3, .direction = 'up') |>
        mutate(
          tn_load_lag1 = rowSums(
            pick(tn_load_lag0:tn_load_lag1),
            na.rm = FALSE
          ),
          tn_load_lag2 = rowSums(
            pick(tn_load_lag0:tn_load_lag2),
            na.rm = FALSE
          ),
          tn_load_lag3 = rowSums(pick(tn_load_lag0:tn_load_lag3), na.rm = FALSE)
        ) |>
        rename(`Lag 3` = tn_load_lag3)
    }),
    data = map(data, function(dat) {
      mod <- newtoprd |> pull(model)
      newdat <- dat |>
        mutate(
          sal = mean(sal, na.rm = TRUE),
          temp = mean(temp, na.rm = TRUE),
          .by = mo
        )
      prd <- predict(
        mod[[1]],
        newdata = newdat,
        type = 'response'
      )
      bind_cols(dat, tibble(predchla = prd))
    }),
    annavg = map(data, function(dat) {
      dat |>
        summarize(
          tn_load = sum(tn_load_lag0, na.rm = TRUE),
          predchla = mean(predchla, na.rm = TRUE),
          .by = yr
        )
    })
  )

toplo <- redscn |>
  select(redscn, data) |>
  unnest(data)

ggplot(toplo, aes(x = date, y = tn_load_lag0)) +
  geom_line(aes(group = redscn, color = redscn)) +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'D') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Monthly Load Reduction Scenarios',
    y = 'tons/month',
    x = NULL
  )

ggplot(toplo, aes(x = date, y = predchla)) +
  geom_line(aes(group = redscn, color = redscn)) +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'C') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Monthly Predicted Chlorophyll-a Under Load Reduction Scenarios',
    y = 'µg/L',
    x = NULL
  )
```

Monthly  model predictions are then aggregated to annual average predicted chlorophyll-a and total nitrogen loads for each load reduction scenario.

```{r}
#| fig-height: 3
toplo2 <- redscn |>
  select(redscn, annavg) |>
  unnest(annavg)

ggplot(toplo2, aes(x = yr, y = tn_load, group = redscn)) +
  geom_line(aes(color = redscn)) +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'D') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Annual Total Nitrogen Loads from Monthly Reduction Scenarios',
    y = 'tons/year',
    x = NULL
  )

ggplot(toplo2, aes(x = yr, y = predchla, group = redscn)) +
  geom_line(aes(color = redscn)) +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'C') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Annual Average Predicted Chlorophyll-a Under Load Reduction Scenarios',
    y = 'µg/L',
    x = NULL
  )
```

```{r}
toplo3 <- toplo2 |>
  summarise(
    avechl = mean(predchla, na.rm = TRUE),
    tn_load = mean(tn_load, na.rm = TRUE),
    .by = c(redscn)
  ) |>
  filter(tn_load > 0)

# get the x-axis load values for 8.5 ug/L chl-a
asscapmod <- lm(
  avechl ~ tn_load,
  data = toplo3
)
asscap <- coefficients(asscapmod)
asscap <- (8.5 - asscap[1]) / asscap[2]
addlns <- tibble(
  avechl = 8.5,
  tn_load = asscap,
)
```

From the load reduction scenarios, the average response of chlorophyll-a to nitrogen load changes was then estimated by taking the average of the annual chlorophyll predictions and the average load estimates for each reduction scenario.  The plots below show each point as the average predicted chlorophyll-a versus the average total nitrogen load for each load reduction scenario.  The dashed red line indicates the target chlorophyll-a concentration of 8.5 µg/L.  The arrow indicates the estimated nitrogen load reductions needed to achieve the target chlorophyll-a concentration based on linear interpolation of the average response curves. The estimated loads needed to achieve 8.5 µg/L chlorophyll-a are `r round(asscap, 0)` tons/year.

```{r}
ggplot(toplo3, aes(x = tn_load, y = avechl)) +
  geom_line() +
  geom_point() +
  geom_segment(
    data = addlns,
    aes(
      x = tn_load,
      y = avechl,
      xend = tn_load,
      yend = 0
    ),
    arrow = arrow(length = unit(0.6, "cm")),
    linetype = 'solid',
  ) +
  geom_text(
    data = addlns,
    aes(
      x = tn_load,
      y = 0,
      label = paste0(
        'Estimated load at 8.5 µg/L: ',
        round(tn_load, 0),
        ' tons/yr'
      )
    ),
    hjust = 1.05,
    vjust = 0,
    size = 3,
    fontface = 'bold'
  ) +
  geom_hline(yintercept = 8.5, linetype = 'dashed', color = 'red') +
  theme_minimal() +
  theme(
    legend.position = 'none'
  ) +
  labs(
    title = 'Average Predicted Chlorophyll-a vs. Average Nitrogen\nLoad Under Load Reduction Scenarios',
    y = 'µg/L',
    x = 'tons/yr',
  )
```

## Load response by year

A final model structure was evaluated that let the load response vary by year.  Only year and load were used as the predictors (month was removed).

$$
\text{chla}_{t} = \beta_1 \left( \Sigma_{i = I_0}^{I_n} L_{t - i} \right) + \beta_2 year_v \left( \Sigma_{i = I_0}^{I_n} L_{t - i} \right) 
$$

where $year_v \left( \Sigma_{i = I_0}^{I_n} L_{t - i} \right)$ is an interaction term between year (as a factor) and the cumulative load evaluated at different lags from $I_0$ for the present month to $I_n$ months.

```{r}
#| fig-height: 2
# create up to six month lags for tn_load
newtomod <- newdat |>
  mutate(
    tn_load_lag1 = lag(tn_load, 1),
    tn_load_lag2 = lag(tn_load, 2),
    tn_load_lag3 = lag(tn_load, 3),
    tn_load_lag4 = lag(tn_load, 4),
    tn_load_lag5 = lag(tn_load, 5),
    tn_load_lag6 = lag(tn_load, 6),
    .by = bay_segment
  ) |>
  rename(tn_load_lag0 = tn_load) |>
  fill(tn_load_lag1:tn_load_lag6, .direction = 'up') |>
  mutate(
    tn_load_lag1 = rowSums(pick(tn_load_lag0:tn_load_lag1), na.rm = FALSE),
    tn_load_lag2 = rowSums(pick(tn_load_lag0:tn_load_lag2), na.rm = FALSE),
    tn_load_lag3 = rowSums(pick(tn_load_lag0:tn_load_lag3), na.rm = FALSE),
    tn_load_lag4 = rowSums(pick(tn_load_lag0:tn_load_lag4), na.rm = FALSE),
    tn_load_lag5 = rowSums(pick(tn_load_lag0:tn_load_lag5), na.rm = FALSE),
    tn_load_lag6 = rowSums(pick(tn_load_lag0:tn_load_lag6), na.rm = FALSE)
  ) |>
  pivot_longer(
    cols = starts_with('tn_load_lag'),
    names_to = 'lag',
    values_to = 'tn_load'
  ) |>
  mutate(
    lag = str_remove(lag, 'tn_load_'),
    lag = str_replace(lag, 'lag', 'Lag ')
  )

mod <- newtomod |>
  group_nest(lag) |>
  mutate(
    model = map(data, function(x) {
      mod <- lm(
        chla ~ tn_load + factor(yr):tn_load,
        data = x
      )

      # get rsq for all
      rsq <- summary(mod)$r.squared

      tibble(
        rsq = rsq
      )
    })
  ) |>
  select(-data) |>
  unnest(model) |>
  pivot_longer(
    cols = starts_with('rsq'),
    names_to = 'period',
    values_to = 'rsq'
  ) |>
  mutate(
    lag = str_remove(lag, 'Lag ')
  )

rsqplo_fun(mod)
```

The monthly observed and predicted chlorophyll-a concentrations are compared for Old Tampa Bay below.

```{r}
newtoprd <- newtomod |>
  pivot_wider(
    names_from = lag,
    values_from = tn_load
  ) |>
  nest() |>
  mutate(
    model = map(data, function(x) {
      glm(
        chla ~ `Lag 3` + factor(yr):`Lag 3`,
        data = x,
        na.action = 'na.exclude'
      )
    }),
    pred = map2(model, data, function(mod, dat) {
      predict(mod, newdata = dat, type = 'response')
    })
  )

toplo <- newtoprd |>
  select(-model) |>
  unnest(c(data, pred))

ggplot(toplo, aes(x = date, y = chla)) +
  geom_point() +
  geom_line(aes(y = pred)) +
  # geom_hline(yintercept = 9.3, linetype = 'dashed', color = 'red') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Monthly Observed and Predicted Chlorophyll-a in Old Tampa Bay',
    y = 'µg/L',
    x = NULL
  )
```

The annual average observed and predicted chlorophyll-a concentrations are compared for Old Tampa Bay below.

```{r}
annavg <- tbeptools::anlz_avedat(epcdata)$ann |>
  filter(bay_segment %in% 'OTB', var == 'mean_chla') |>
  filter(yr >= 2000)

modestavg <- toplo |>
  summarize(
    predchla = mean(pred, na.rm = TRUE),
    .by = c(yr)
  )

ggplot(annavg, aes(x = yr, y = val)) +
  geom_line(aes(color = 'Observed')) +
  geom_point(aes(color = 'Observed'), size = 3) +
  geom_line(data = modestavg, aes(x = yr, y = predchla, color = 'Predicted')) +
  geom_point(
    data = modestavg,
    aes(x = yr, y = predchla, color = 'Predicted'),
    size = 3
  ) +
  scale_color_manual(
    values = c('Observed' = 'black', 'Predicted' = 'cornflowerblue')
  ) +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  guides(color = guide_legend(override.aes = list(shape = NA))) +
  labs(
    title = 'Annual Average Observed and Predicted Chlorophyll-a in Old Tampa Bay',
    y = 'µg/L',
    x = 'Year',
    color = NULL
  )
```

Monthly and annual model predictions are then generated for various nitrogen load reduction scenarios using the new log-model with additional predictors. Monthly loads are reduced by fractions ranging from 0% to 100% in 5% increments. The models are then used to predict chlorophyll-a concentrations under each load reduction scenario.

```{r}
#| fig-height: 3
redscn <- crossing(
  redscn = seq(0, 1, by = 0.05), #10^(seq(log10(0.001), log10(1), length.out = 10)),
  newdat
) |>
  group_nest(redscn) |>
  mutate(
    data = pmap(list(redscn, data), function(red, dat) {
      dat |>
        mutate(
          tn_load_lag0 = tn_load * red,
          tn_load_lag1 = lag(tn_load_lag0, 1),
          tn_load_lag2 = lag(tn_load_lag0, 2),
          tn_load_lag3 = lag(tn_load_lag0, 3)
        ) |>
        fill(tn_load_lag1:tn_load_lag3, .direction = 'up') |>
        mutate(
          tn_load_lag1 = rowSums(
            pick(tn_load_lag0:tn_load_lag1),
            na.rm = FALSE
          ),
          tn_load_lag2 = rowSums(
            pick(tn_load_lag0:tn_load_lag2),
            na.rm = FALSE
          ),
          tn_load_lag3 = rowSums(pick(tn_load_lag0:tn_load_lag3), na.rm = FALSE)
        ) |>
        rename(`Lag 3` = tn_load_lag3)
    }),
    data = map(data, function(dat) {
      mod <- newtoprd |> pull(model)
      prd <- predict(
        mod[[1]],
        newdata = dat,
        type = 'response'
      )
      bind_cols(dat, tibble(predchla = prd))
    }),
    annavg = map(data, function(dat) {
      dat |>
        summarize(
          tn_load = sum(tn_load_lag0, na.rm = TRUE),
          predchla = mean(predchla, na.rm = TRUE),
          .by = yr
        )
    })
  )

toplo <- redscn |>
  select(redscn, data) |>
  unnest(data)

ggplot(toplo, aes(x = date, y = tn_load_lag0)) +
  geom_line(aes(group = redscn, color = redscn)) +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'D') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Monthly Load Reduction Scenarios',
    y = 'tons/month',
    x = NULL
  )

ggplot(toplo, aes(x = date, y = predchla)) +
  geom_line(aes(group = redscn, color = redscn)) +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'C') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Monthly Predicted Chlorophyll-a Under Load Reduction Scenarios',
    y = 'µg/L',
    x = NULL
  )
```

Monthly  model predictions are then aggregated to annual average predicted chlorophyll-a and total nitrogen loads for each load reduction scenario.

```{r}
#| fig-height: 3
toplo2 <- redscn |>
  select(redscn, annavg) |>
  unnest(annavg)

ggplot(toplo2, aes(x = yr, y = tn_load, group = redscn)) +
  geom_line(aes(color = redscn)) +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'D') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Annual Total Nitrogen Loads from Monthly Reduction Scenarios',
    y = 'tons/year',
    x = NULL
  )

ggplot(toplo2, aes(x = yr, y = predchla, group = redscn)) +
  geom_line(aes(color = redscn)) +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'C') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Annual Average Predicted Chlorophyll-a Under Load Reduction Scenarios',
    y = 'µg/L',
    x = NULL
  )
```

```{r}
toplo3 <- toplo2 |>
  summarise(
    avechl = mean(predchla, na.rm = TRUE),
    tn_load = mean(tn_load, na.rm = TRUE),
    .by = c(redscn)
  ) |>
  filter(tn_load > 0)

# get the x-axis load values for 8.5 ug/L chl-a
asscapmod <- lm(
  avechl ~ tn_load,
  data = toplo3
)
asscap <- coefficients(asscapmod)
asscap <- (8.5 - asscap[1]) / asscap[2]
addlns <- tibble(
  avechl = 8.5,
  tn_load = asscap,
)
```

From the load reduction scenarios, the average response of chlorophyll-a to nitrogen load changes was then estimated by taking the average of the annual chlorophyll predictions and the average load estimates for each reduction scenario.  The plots below show each point as the average predicted chlorophyll-a versus the average total nitrogen load for each load reduction scenario.  The dashed red line indicates the target chlorophyll-a concentration of 8.5 µg/L.  The arrow indicates the estimated nitrogen load reductions needed to achieve the target chlorophyll-a concentration based on linear interpolation of the average response curves. The estimated loads needed to achieve 8.5 µg/L chlorophyll-a are `r round(asscap, 0)` tons/year.

```{r}
ggplot(toplo3, aes(x = tn_load, y = avechl)) +
  geom_line() +
  geom_point() +
  geom_segment(
    data = addlns,
    aes(
      x = tn_load,
      y = avechl,
      xend = tn_load,
      yend = 0
    ),
    arrow = arrow(length = unit(0.6, "cm")),
    linetype = 'solid',
  ) +
  geom_text(
    data = addlns,
    aes(
      x = tn_load,
      y = 0,
      label = paste0(
        'Estimated load at 8.5 µg/L: ',
        round(tn_load, 0),
        ' tons/yr'
      )
    ),
    hjust = 1.05,
    vjust = 0,
    size = 3,
    fontface = 'bold'
  ) +
  geom_hline(yintercept = 8.5, linetype = 'dashed', color = 'red') +
  theme_minimal() +
  theme(
    legend.position = 'none'
  ) +
  labs(
    title = 'Average Predicted Chlorophyll-a vs. Average Nitrogen\nLoad Under Load Reduction Scenarios',
    y = 'µg/L',
    x = 'tons/yr',
  )
```