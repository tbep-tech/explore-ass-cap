---
title: "Exploring the Assimilative Capacity of Old Tampa Bay"
author: "Tampa Bay Estuary Program"
date: "`r Sys.Date()`"
format:
  html:
    theme: cosmo
    code-tools: 
      source: https://github.com/tbep-tech/explore-ass-cap/blob/main/docs/explore.qmd
    css: styles.css
toc: true
lightbox: true
execute:
  echo: false
  warning: false
---

```{r}
#| include: false
library(tidyverse)
library(here)
library(patchwork)
library(GGally)

source(here('R/funcs.R'))

data(epcdata, package = 'tbeptools')
load(file = here('data/lddat.RData'))
load(file = here('data/pinchl.RData'))

# bay segment chl aves
chlmo <- tbeptools::anlz_avedat(epcdata)$mos |>
  filter(var == 'mean_chla') |>
  rename(chla = val) |>
  select(-var) |>
  mutate(
    date = make_date(yr, mo, day = 1)
  ) |>
  filter(yr >= 2000)

# add salinity, temp, join with monthly chlorophyll, tn data, create tn lags
tomod <- epcdata |>
  mutate(
    date = make_date(yr, mo, day = 1)
  ) |>
  mutate(
    sal = mean(
      c(Sal_Top_ppth, Sal_Mid_ppth, Sal_Bottom_ppth),
      na.rm = T
    ),
    temp = mean(
      c(Temp_Water_Top_degC, Temp_Water_Mid_degC, Temp_Water_Bottom_degC),
      na.rm = T
    ),
    .by = c(epchc_station, date)
  ) |>
  summarise(
    sal = mean(sal, na.rm = T),
    temp = mean(temp, na.rm = T),
    .by = c(bay_segment, date, yr, mo)
  ) |>
  inner_join(chlmo, by = c('bay_segment', 'date', 'yr', 'mo')) |>
  inner_join(lddat, by = c('bay_segment', 'date', 'yr', 'mo')) |>
  arrange(date) |>
  mutate(
    tn_load_lag1 = lag(tn_load, 1),
    tn_load_lag2 = lag(tn_load, 2),
    tn_load_lag3 = lag(tn_load, 3),
    tn_load_lag4 = lag(tn_load, 4),
    tn_load_lag5 = lag(tn_load, 5),
    tn_load_lag6 = lag(tn_load, 6),
    .by = bay_segment
  ) |>
  rename(tn_load_lag0 = tn_load) |>
  fill(tn_load_lag1:tn_load_lag6, .direction = 'up') |>
  mutate(
    tn_load_lag1 = rowSums(pick(tn_load_lag0:tn_load_lag1), na.rm = FALSE),
    tn_load_lag2 = rowSums(pick(tn_load_lag0:tn_load_lag2), na.rm = FALSE),
    tn_load_lag3 = rowSums(pick(tn_load_lag0:tn_load_lag3), na.rm = FALSE),
    tn_load_lag4 = rowSums(pick(tn_load_lag0:tn_load_lag4), na.rm = FALSE),
    tn_load_lag5 = rowSums(pick(tn_load_lag0:tn_load_lag5), na.rm = FALSE),
    tn_load_lag6 = rowSums(pick(tn_load_lag0:tn_load_lag6), na.rm = FALSE)
  ) |>
  pivot_longer(
    cols = starts_with('tn_load_lag'),
    names_to = 'lag',
    values_to = 'tn_load'
  ) |>
  mutate(
    lag = str_remove(lag, 'tn_load_'),
    lag = str_replace(lag, 'lag', 'Lag ')
  )

# pinellas chlorophyll a data
pinchlsum <- pinchl |>
  mutate(
    date = floor_date(date, unit = 'months')
  ) |>
  summarise(
    chla = mean(`Chl-a`, na.rm = T),
    sal = mean(sal, na.rm = T),
    temp = mean(temp, na.rm = T),
    .by = c(strata, date)
  ) |>
  summarise(
    chla = mean(chla, na.rm = T),
    sal = mean(sal, na.rm = T),
    temp = mean(temp, na.rm = T),
    .by = date
  ) |>
  mutate(
    yr = year(date),
    mo = month(date)
  )

# combine summarized pinchl data to load lag data from previous to mod
pintomod <- tomod |>
  select(-sal, -temp, -chla) |>
  filter(bay_segment %in% 'OTB') |>
  inner_join(
    pinchlsum,
    by = c('yr', 'mo', 'date'),
    relationship = 'many-to-one'
  )
```

## Premise

* Keep it simple!
* Evaluate prior models with additional years of data, slight tweaks to model structure
* Build off evidence for assimilative capacity studies (task reports [1](https://drive.google.com/file/d/1IfVUTLE20wzVgzULuyeRGWapEFT3DhQ0/view?usp=drive_link), [2](https://drive.google.com/file/d/12xYfSs-4bxhLa1ZVQbmhQSv5Jo4Jf-oY/view?usp=sharing), [3](https://drive.google.com/file/d/1uVeMIpSylz1Mull6WMwVDc7KVInzosqy/view?usp=sharing))

## Model 1 (Original), All Bay Segments 

The cumulative lag model from [Janicki and Wade 1996](https://drive.google.com/file/d/1kZkvuprvsMyN9nPS5PHYvXHyo1KQxKTr/view) is specified as:

$$
\text{chla}_{t, s} = \alpha_{t, s} + \beta_s \left( \Sigma_{i = I_0}^{I_n} L_{t - i, s} \right)
$$

where $\text{chla}_{t, s}$ is the chlorophyll-a concentration at month $t$ and bay segment $s$, $\alpha_{t, s}$ is the intercept term that varies by $t$ and $s$, $\beta_s$ is the coefficient for the cumulative load term that varies by $s$, and $L_{t - 1, s}$ is the cumulative nitrogen nitrogen load evaluated at different lags from $I_0$ as the present month in the time series to $I_n$ months for each $s$.

Models are created with the following linear model structure in  R, where the `tn_load` variable is the cumulative lag load for different $n$ lags.

```{r}
#| eval: false
#| echo: true
chla ~ factor(bay_segment):factor(mo) + tn_load:factor(bay_segment)
```

```{r}
#| fig-height: 2
# create scatterplots of chla vs tn_load with linear fits for each lag
lagplo_fun(tomod, '2000 to 2024', '#F8766D')
```

```{r}
#| fig-height: 2
mod <- rsqmod_fun(
  tomod,
  'chla ~ factor(bay_segment):factor(mo) + tn_load:factor(bay_segment)'
)
rsqplo_fun(mod)
```

## Model 1: OTB Only

The models are the same as above except the bay segment term is removed since only OTB is being modeled.

The cumulative lag model from is specified as:

$$
\text{chla}_{t} = \alpha_{t} + \beta \left( \Sigma_{i = I_0}^{I_n} L_{t - i} \right)
$$

where $\text{chla}_{t}$ is the chlorophyll-a concentration at month $t$, $\alpha_{t}$ is the intercept term that varies by $t$, $\beta$ is the coefficient for the cumulative load term, and $L_{t - i}$ is the cumulative nitrogen load evaluated at different lags from $I_0$ for the present month to $I_n$ months.

Models are run with the following linear model structure in  R, where the `tn_load` variable is the cumulative lag load for different $n$ lags.

```{r}
#| eval: false
#| echo: true
chla ~ factor(mo) + tn_load
```

```{r}
#| fig-height: 2
tomodotb <- tomod |>
  filter(bay_segment %in% 'OTB')

# create scatterplots of chla vs tn_load with linear fits for each lag
lagplo_fun(tomodotb, '2000 to 2024', '#F8766D')
```

```{r}
#| fig-height: 2
mod <- rsqmod_fun(tomodotb, 'chla ~ factor(mo) + tn_load')
rsqplo_fun(mod)
```

## Model 1: Assimilative Capacity Analysis

The cumulative lag model with a 3-month lag was chosen for the assimilative capacity analysis based on the results above and previous work by Janicki and Wade (1996).

```{r}
toprdotb <- mod_fun(tomodotb, 'chla ~ factor(mo) + `Lag 3`')
modprd_fun(toprdotb, 'mo')
```

The annual average observed and predicted chlorophyll-a concentrations are compared for Old Tampa Bay below.

```{r}
modprd_fun(toprdotb, 'yr')
```

The assimilative capacity analysis involves simulating various nitrogen load reduction scenarios and predicting the resulting chlorophyll-a concentrations using the developed models. Monthly loads are reduced by fractions ranging from 0% to 100% in 5% increments. The models are then used to predict chlorophyll-a concentrations under each load reduction scenario.

```{r}
#| fig-height: 3
# load reduction scenarios
redscn <- redscn_fun(toprdotb)
redscn_plo(redscn, 'mo', 'tn')
redscn_plo(redscn, 'mo', 'chla')
```

Monthly  model predictions are then aggregated to annual average predicted chlorophyll-a and total nitrogen loads for each load reduction scenario.

```{r}
#| fig-height: 3
redscn_plo(redscn, 'yr', 'tn')
redscn_plo(redscn, 'yr', 'chla')
```

```{r}
asscapdata <- asscapdata_fun(redscn)
asscap <- asscap_fun(asscapdata)
```

The average response of chlorophyll-a to nitrogen load changes was then estimated by taking the average of the annual chlorophyll predictions and the average load estimates for each reduction scenario.  

```{r}
#| layout-ncol: 2
#| fig-height: 3
redscnaggplo_fun(asscapdata, redscn, 'tn')
redscnaggplo_fun(asscapdata, redscn, 'chla')
```

The plot below show each point as the average predicted chlorophyll-a versus the average total nitrogen load for each load reduction scenario.  The dashed red line indicates the target chlorophyll-a concentration of 8.5 µg/L.  The arrow indicates the estimated nitrogen load reductions needed to achieve the target chlorophyll-a concentration based on linear interpolation of the average response curves. The estimated loads needed to achieve 8.5 µg/L chlorophyll-a are `r round(asscap, 0)` tons/year.

```{r}
asscap_plo(asscapdata, asscap)
```

## Model 2: Log-Model with Additional Predictors

The above models used to predict the assimilative capacity of Old Tampa Bay, particularly for the period after 2010, likely provide an overestimate of how much loading the bay segment can assimilate.  This is evident by evaluating the residual patterns - the model does not capture extreme values.  Results could be improved by modeling an inherently log-normal response variable and including additional predictors to provide a more accurate estimate of how nitrogen load influences chlorophyll-a.

```{r}
mod <- toprdotb$model[[1]]
ggplot(data.frame(residuals = residuals(mod)), aes(sample = residuals)) +
  stat_qq() +
  stat_qq_line(color = 'red') +
  labs(
    title = "Normal Q-Q Plot of Residuals from the OTB Model",
    x = "Theoretical Quantiles",
    y = "Sample Quantiles"
  ) +
  theme_minimal()
```

To address this issue, an additional model was developed using log-transformed chlorophyll-a as the response variable and additional predictors, including salinity and temperature. 

```{r}
toplo <- tomodotb |>
  filter(lag %in% 'Lag 0') |>
  select(chla, sal, temp, tn_load) |>
  distinct() |>
  mutate(
    chla = log10(chla),
    tn_load = log10(tn_load)
  )

ggpairs(toplo)
```

Collinearity among the new predictors was assessed using variance inflation factors (VIFs), where chlorophyll and load are log-transformed.  The values are sufficiently low to include all predictors in the model.

```{r}
# check vif
mod <- lm(
  chla ~ sal + temp + tn_load,
  data = toplo
)
car::vif(mod)
```

The above analyses were repeated with the following changes to the model structure:

$$
log_{10}\text{chla}_{t} = \alpha_{t} + \beta_1 log_{10}\left( \Sigma_{i = I_0}^{I_n} L_{t - i} \right) + \beta_2 \text{sal}_{t} + \beta_3 \text{temp}_{t}
$$

where the coefficients $\beta_2$ and $\beta_3$ represent the influence of salinity and temperature on chlorophyll-a concentrations.  Chlorophyll is modelled using a log-normal distribution to better capture extreme values and loading is also log-transformed. Below shows the explained deviance (pseudo-r-squared) for each cumulative lag model.

```{r}
#| fig-height: 2
mod <- rsqmod_fun(
  tomodotb,
  frmtxt = 'chla ~ factor(mo) + log10(1 + tn_load) + sal + temp',
  useglm = T
)
rsqplo_fun(mod)
```

The monthly observed and predicted chlorophyll-a concentrations are compared for Old Tampa Bay below.

```{r}
toprdotb <- mod_fun(
  tomodotb,
  'chla ~ factor(mo) + log10(1 + `Lag 3`) + sal + temp',
  useglm = T
)
modprd_fun(toprdotb, 'mo')
```

The annual average observed and predicted chlorophyll-a concentrations are compared for Old Tampa Bay below.

```{r}
modprd_fun(toprdotb, 'yr')
```

Monthly and annual model predictions are then generated for various nitrogen load reduction scenarios using the new log-model with additional predictors. Monthly loads are reduced by fractions ranging from 0% to 100% in 5% increments. The models are then used to predict chlorophyll-a concentrations under each load reduction scenario.  __Salinity and temperature are held constant at their monthly average values for each month across the entire time series.__

```{r}
#| fig-height: 3
redscn <- redscn_fun(toprdotb, type = 'response')
redscn_plo(redscn, 'mo', 'tn')
redscn_plo(redscn, 'mo', 'chla')
```

Monthly  model predictions are then aggregated to annual average predicted chlorophyll-a and total nitrogen loads for each load reduction scenario.

```{r}
#| fig-height: 3
redscn_plo(redscn, 'yr', 'tn')
redscn_plo(redscn, 'yr', 'chla')
```

```{r}
asscapdata <- asscapdata_fun(redscn)
asscap <- asscap_fun(asscapdata)
```

From the load reduction scenarios, the average response of chlorophyll-a to nitrogen load changes was then estimated by taking the average of the annual chlorophyll predictions and the average load estimates for each reduction scenario.  

```{r}
#| layout-ncol: 2
#| fig-height: 3
redscnaggplo_fun(asscapdata, redscn, 'tn')
redscnaggplo_fun(asscapdata, redscn, 'chla')
```

The plots below show each point as the average predicted chlorophyll-a versus the average total nitrogen load for each load reduction scenario.  The dashed red line indicates the target chlorophyll-a concentration of 8.5 µg/L.  The arrow indicates the estimated nitrogen load reductions needed to achieve the target chlorophyll-a concentration based on linear interpolation of the average response curves. The estimated loads needed to achieve 8.5 µg/L chlorophyll-a are `r round(asscap, 0)` tons/year.

```{r}
asscap_plo(asscapdata, asscap)
```

## Model 3: Load Response by Year

A final model structure was evaluated that let the load response vary by year.  Only year and load were used as the predictors (month was removed).

$$
\text{chla}_{t} = \beta_1 \left( \Sigma_{i = I_0}^{I_n} L_{t - i} \right) + \beta_2 year_v \left( \Sigma_{i = I_0}^{I_n} L_{t - i} \right) 
$$

where $year_v \left( \Sigma_{i = I_0}^{I_n} L_{t - i} \right)$ is an interaction term between year (as a factor) and the cumulative load evaluated at different lags from $I_0$ for the present month to $I_n$ months.

```{r}
#| fig-height: 2
mod <- rsqmod_fun(tomodotb, 'chla ~ tn_load + factor(yr):tn_load')
rsqplo_fun(mod)
```

The monthly observed and predicted chlorophyll-a concentrations are compared for Old Tampa Bay below.

```{r}
toprdotb <- mod_fun(tomodotb, 'chla ~ `Lag 3` + factor(yr):`Lag 3`')
modprd_fun(toprdotb, 'mo')
```

The annual average observed and predicted chlorophyll-a concentrations are compared for Old Tampa Bay below.

```{r}
modprd_fun(toprdotb, 'yr')
```

Monthly and annual model predictions are then generated for various nitrogen load reduction scenarios using the new log-model with additional predictors. Monthly loads are reduced by fractions ranging from 0% to 100% in 5% increments. The models are then used to predict chlorophyll-a concentrations under each load reduction scenario.

```{r}
#| fig-height: 3
redscn <- redscn_fun(toprdotb)
redscn_plo(redscn, 'mo', 'tn')
redscn_plo(redscn, 'mo', 'chla')
```

Monthly  model predictions are then aggregated to annual average predicted chlorophyll-a and total nitrogen loads for each load reduction scenario.

```{r}
#| fig-height: 3
redscn_plo(redscn, 'yr', 'tn')
redscn_plo(redscn, 'yr', 'chla')
```

```{r}
asscapdata <- asscapdata_fun(redscn)
asscap <- asscap_fun(asscapdata)
```

From the load reduction scenarios, the average response of chlorophyll-a to nitrogen load changes was then estimated by taking the average of the annual chlorophyll predictions and the average load estimates for each reduction scenario. 

```{r}
#| layout-ncol: 2
#| fig-height: 3
redscnaggplo_fun(asscapdata, redscn, 'tn')
redscnaggplo_fun(asscapdata, redscn, 'chla')
```

 The plot below shows each point as the average predicted chlorophyll-a versus the average total nitrogen load for each load reduction scenario.  The dashed red line indicates the target chlorophyll-a concentration of 8.5 µg/L.  The arrow indicates the estimated nitrogen load reductions needed to achieve the target chlorophyll-a concentration based on linear interpolation of the average response curves. The estimated loads needed to achieve 8.5 µg/L chlorophyll-a are `r round(asscap, 0)` tons/year.

```{r}
asscap_plo(asscapdata, asscap)
```

## OTB Pinellas County Data

The above analyses for Old Tampa Bay were repeated using monitoring data from Pinellas County.  Chlorophyll data (corrected for Pheophytin) are availale from 2003 to present.  The three models were evaluated to assess the potential loading associated with 8.5 $\mu$g/L of chlorophyll.  Only relevant plots and model summaries are shown below.

### Model 1

$$
\text{chla}_{t} = \alpha_{t} + \beta \left( \Sigma_{i = I_0}^{I_n} L_{t - i} \right)
$$

```{r}
#| fig-height: 2
mod <- rsqmod_fun(pintomod, 'chla ~ factor(mo) + tn_load')
rsqplo_fun(mod)
```

```{r}
toprdotb <- mod_fun(pintomod, 'chla ~ factor(mo) + `Lag 3`')
modprd_fun(toprdotb, 'yr')
```

```{r}
redscn <- redscn_fun(toprdotb)
asscapdata <- asscapdata_fun(redscn)
asscap <- asscap_fun(asscapdata)
```

Estimated loaded need to achieve 8.5 $\mu$g/L chlorophyll-a are `r round(asscap, 0)` tons/year.

```{r}
asscap_plo(asscapdata, asscap)
```

### Model 2

$$
log_{10}\text{chla}_{t} = \alpha_{t} + \beta_1 log_{10}\left( \Sigma_{i = I_0}^{I_n} L_{t - i} \right) + \beta_2 \text{temp}_{t}
$$

Note: Salinity not included in this model. 

```{r}
#| fig-height: 2
mod <- rsqmod_fun(
  pintomod,
  'chla ~ factor(mo) + log10(1 + tn_load) + temp',
  useglm = T
)
rsqplo_fun(mod)
```

```{r}
toprdotb <- mod_fun(
  pintomod,
  'chla ~ factor(mo) + log10(1 + `Lag 3`) + temp',
  useglm = T
)
modprd_fun(toprdotb, 'yr')
```

```{r}
redscn <- redscn_fun(toprdotb, type = 'response')
asscapdata <- asscapdata_fun(redscn)
asscap <- asscap_fun(asscapdata)
```

Estimated loaded need to achieve 8.5 $\mu$g/L chlorophyll-a are `r round(asscap, 0)` tons/year.

```{r}
asscap_plo(asscapdata, asscap)
```

### Model 3

$$
\text{chla}_{t} = \beta_1 \left( \Sigma_{i = I_0}^{I_n} L_{t - i} \right) + \beta_2 year_v \left( \Sigma_{i = I_0}^{I_n} L_{t - i} \right) 
$$

```{r}
#| fig-height: 2
mod <- rsqmod_fun(pintomod, 'chla ~ tn_load + factor(yr):tn_load')
rsqplo_fun(mod)
```

```{r}
toprdotb <- mod_fun(pintomod, 'chla ~ `Lag 3` + factor(yr):`Lag 3`')
modprd_fun(toprdotb, 'yr')
```

```{r}
redscn <- redscn_fun(toprdotb)
asscapdata <- asscapdata_fun(redscn)
asscap <- asscap_fun(asscapdata)
```

Estimated loaded need to achieve 8.5 $\mu$g/L chlorophyll-a are `r round(asscap, 0)` tons/year.

```{r}
asscap_plo(asscapdata, asscap)
```
