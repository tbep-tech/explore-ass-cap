---
title: "Exploring the Assimilative Capacity of Old Tampa Bay"
author: "Tampa Bay Estuary Program"
date: "`r Sys.Date()`"
format:
  html:
    theme: cosmo
    code-tools: 
      source: https://github.com/tbep-tech/explore-ass-cap/blob/main/docs/explore.qmd
    css: styles.css
toc: true
lightbox: true
execute:
  echo: false
  warning: false
---

```{r}
#| include: false
library(tidyverse)
library(here)
library(patchwork)
library(GGally)

source(here('R/funcs.R'))

data(epcdata, package = 'tbeptools')
load(file = here('data/lddat.RData'))

# bay segment chl aves
wqmo <- tbeptools::anlz_avedat(epcdata)$mos |>
  filter(var == 'mean_chla') |>
  rename(chla = val) |>
  select(-var) |>
  mutate(
    date = make_date(yr, mo, day = 1)
  )

# join and create up to six month lags for tn_load
tomod <- inner_join(wqmo, lddat, by = c('bay_segment', 'date', 'yr', 'mo')) |>
  mutate(
    tn_load_lag1 = lag(tn_load, 1),
    tn_load_lag2 = lag(tn_load, 2),
    tn_load_lag3 = lag(tn_load, 3),
    tn_load_lag4 = lag(tn_load, 4),
    tn_load_lag5 = lag(tn_load, 5),
    tn_load_lag6 = lag(tn_load, 6),
    yrcat = ifelse(yr < 2010, 'Before 2010', '2010 and After'),
    .by = bay_segment
  ) |>
  rename(tn_load_lag0 = tn_load)

tomodadd <- tomod |>
  mutate(
    tn_load_lag1 = rowSums(pick(tn_load_lag0:tn_load_lag1), na.rm = FALSE),
    tn_load_lag2 = rowSums(pick(tn_load_lag0:tn_load_lag2), na.rm = FALSE),
    tn_load_lag3 = rowSums(pick(tn_load_lag0:tn_load_lag3), na.rm = FALSE),
    tn_load_lag4 = rowSums(pick(tn_load_lag0:tn_load_lag4), na.rm = FALSE),
    tn_load_lag5 = rowSums(pick(tn_load_lag0:tn_load_lag5), na.rm = FALSE),
    tn_load_lag6 = rowSums(pick(tn_load_lag0:tn_load_lag6), na.rm = FALSE)
  ) |>
  pivot_longer(
    cols = starts_with('tn_load_lag'),
    names_to = 'lag',
    values_to = 'tn_load'
  ) |>
  mutate(
    lag = str_remove(lag, 'tn_load_'),
    lag = str_replace(lag, 'lag', 'Lag ')
  )

tomodind <- tomod |>
  pivot_longer(
    cols = starts_with('tn_load_lag'),
    names_to = 'lag',
    values_to = 'tn_load'
  ) |>
  mutate(
    lag = str_remove(lag, 'tn_load_'),
    lag = str_replace(lag, 'lag', 'Lag ')
  )
```

## Original Model, All Bay Segments 

The cumulative lag model from [Janicki and Wade 1996](https://drive.google.com/file/d/1kZkvuprvsMyN9nPS5PHYvXHyo1KQxKTr/view) is specified as:

$$
\text{chla}_{t, s} = \alpha_{t, s} + \beta_s \left( \Sigma_{i = I_0}^{I_n} L_{t - i, s} \right)
$$

where $\text{chla}_{t, s}$ is the chlorophyll-a concentration at month $t$ and bay segment $s$, $\alpha_{t, s}$ is the intercept term that varies by $t$ and $s$, $\beta_s$ is the coefficient for the cumulative load term that varies by $s$, and $L_{t - 1, s}$ is the cumulative nitrogen nitrogen load evaluated at different lags from $I_0$ as the present month in the time series to $I_n$ months for each $s$.

The individaul lag model is specified as:
$$
\text{chla}_{t, s} = \alpha_{t, s} + \beta_s L_{I_n, s}
$$

where $\text{chla}_{t, s}$ is the chlorophyll-a concentration at month $t$ and bay segment $s$, $\alpha_{t, s}$ is the intercept term that varies by $t$ and $s$, $\beta_s$ is the coefficient for the individual load term that varies by $s$, and $L_{t, s}$ is the individual nitrogen load evaluated at different monthly $I_n$ lags for each $s$.

Both models are run with the following linear model structure in  R, where the `tn_load` variable is either the cumulative or individual lag load for different $n$ lags.

```{r}
#| eval: false
#| echo: true
chla ~ factor(bay_segment):factor(mo) + tn_load:factor(bay_segment)
```

::: {.panel-tabset}

### Cumulative Lags

```{r}
# create scatterplots of chla vs tn_load with linear fits for each lag
pall <- lagplo_fun(tomodadd, '1995 to 2024', '#F8766D')
ppre <- lagplo_fun(
  tomodadd[tomodadd$yrcat %in% 'Before 2010', ],
  'Before 2010',
  '#00BA38'
)
ppos <- lagplo_fun(
  tomodadd[tomodadd$yrcat %in% '2010 and After', ],
  '2010 and After',
  '#619CFF'
)

pall + ppre + ppos + plot_layout(ncol = 1, axis_titles = 'collect')
```

```{r}
mod <- tomodadd |>
  group_nest(lag) |>
  mutate(
    model = map(data, function(x) {
      modall <- lm(
        chla ~ factor(bay_segment):factor(mo) + tn_load:factor(bay_segment),
        data = x
      )
      modpre <- lm(
        chla ~ factor(bay_segment):factor(mo) + tn_load:factor(bay_segment),
        data = x[x$yrcat == 'Before 2010', ]
      )
      modpos <- lm(
        chla ~ factor(bay_segment):factor(mo) + tn_load:factor(bay_segment),
        data = x[x$yrcat == '2010 and After', ]
      )

      # get rsq for all
      rsqall <- summary(modall)$r.squared
      rsqpre <- summary(modpre)$r.squared
      rsqpos <- summary(modpos)$r.squared

      tibble(
        rsqall = rsqall,
        rsqpre = rsqpre,
        rsqpos = rsqpos
      )
    })
  ) |>
  select(-data) |>
  unnest(model) |>
  pivot_longer(
    cols = starts_with('rsq'),
    names_to = 'period',
    values_to = 'rsq'
  ) |>
  mutate(
    lag = str_remove(lag, 'Lag '),
    period = case_when(
      period == 'rsqall' ~ '1995 to 2024',
      period == 'rsqpre' ~ 'Before 2010',
      period == 'rsqpos' ~ '2010 and After'
    ),
    period = factor(
      period,
      levels = c('1995 to 2024', 'Before 2010', '2010 and After')
    )
  )

rsqplo_fun(mod)
```

### Individual Lags

```{r}
# create scatterplots of chla vs tn_load with linear fits for each lag
pall <- lagplo_fun(tomodind, '1995 to 2024', '#F8766D')
ppre <- lagplo_fun(
  tomodind[tomodind$yrcat %in% 'Before 2010', ],
  'Before 2010',
  '#00BA38'
)
ppos <- lagplo_fun(
  tomodind[tomodind$yrcat %in% '2010 and After', ],
  '2010 and After',
  '#619CFF'
)

pall + ppre + ppos + plot_layout(ncol = 1, axis_titles = 'collect')
```

```{r}
mod <- tomodind |>
  group_nest(lag) |>
  mutate(
    model = map(data, function(x) {
      modall <- lm(
        chla ~ factor(bay_segment):factor(mo) + tn_load:factor(bay_segment),
        data = x
      )
      modpre <- lm(
        chla ~ factor(bay_segment):factor(mo) + tn_load:factor(bay_segment),
        data = x[x$yrcat == 'Before 2010', ]
      )
      modpos <- lm(
        chla ~ factor(bay_segment):factor(mo) + tn_load:factor(bay_segment),
        data = x[x$yrcat == '2010 and After', ]
      )

      # get rsq for all
      rsqall <- summary(modall)$r.squared
      rsqpre <- summary(modpre)$r.squared
      rsqpos <- summary(modpos)$r.squared

      tibble(
        rsqall = rsqall,
        rsqpre = rsqpre,
        rsqpos = rsqpos
      )
    })
  ) |>
  select(-data) |>
  unnest(model) |>
  pivot_longer(
    cols = starts_with('rsq'),
    names_to = 'period',
    values_to = 'rsq'
  ) |>
  mutate(
    lag = str_remove(lag, 'Lag '),
    period = case_when(
      period == 'rsqall' ~ '1995 to 2024',
      period == 'rsqpre' ~ 'Before 2010',
      period == 'rsqpos' ~ '2010 and After'
    ),
    period = factor(
      period,
      levels = c('1995 to 2024', 'Before 2010', '2010 and After')
    )
  )

rsqplo_fun(mod)
```

:::

## OTB Only Model

The models are the same as above except the bay segment term is removed since only OTB is being modeled.

The cumulative lag model from is specified as:

$$
\text{chla}_{t} = \alpha_{t} + \beta \left( \Sigma_{i = I_0}^{I_n} L_{t - i} \right)
$$

where $\text{chla}_{t}$ is the chlorophyll-a concentration at month $t$, $\alpha_{t}$ is the intercept term that varies by $t$, $\beta$ is the coefficient for the cumulative load term, and $L_{t - i}$ is the cumulative nitrogen load evaluated at different lags from $I_0$ for the present month to $I_n$ months.

The individaul lag model is specified as:
$$
\text{chla}_{t} = \alpha_{t} + \beta L_{I_n}
$$

where $\text{chla}_{t}$ is the chlorophyll-a concentration at month $t$, $\alpha_{t}$ is the intercept term that varies by $t$, $\beta$ is the coefficient for the individual load term, and $L_{I_n}$ is the individual nitrogen load evaluated at different monthly $I_n$ lags.

Both models are run with the following linear model structure in  R, where the `tn_load` variable is either the cumulative or individual lag load for different $n$ lags.

```{r}
#| eval: false
#| echo: true
chla ~ factor(mo) + tn_load
```

::: {.panel-tabset}

### Cumulative Lags

```{r}
tomodaddotb <- tomodadd |>
  filter(bay_segment %in% 'OTB')

# create scatterplots of chla vs tn_load with linear fits for each lag
pall <- lagplo_fun(tomodaddotb, '1995 to 2024', '#F8766D')
ppre <- lagplo_fun(
  tomodaddotb[tomodaddotb$yrcat %in% 'Before 2010', ],
  'Before 2010',
  '#00BA38'
)
ppos <- lagplo_fun(
  tomodaddotb[tomodaddotb$yrcat %in% '2010 and After', ],
  '2010 and After',
  '#619CFF'
)

pall + ppre + ppos + plot_layout(ncol = 1, axis_titles = 'collect')
```

```{r}
mod <- tomodaddotb |>
  group_nest(lag) |>
  mutate(
    model = map(data, function(x) {
      modall <- lm(
        chla ~ factor(mo) + tn_load,
        data = x
      )
      modpre <- lm(
        chla ~ factor(mo) + tn_load,
        data = x[x$yrcat == 'Before 2010', ]
      )
      modpos <- lm(
        chla ~ factor(mo) + tn_load,
        data = x[x$yrcat == '2010 and After', ]
      )

      # get rsq for all
      rsqall <- summary(modall)$r.squared
      rsqpre <- summary(modpre)$r.squared
      rsqpos <- summary(modpos)$r.squared

      tibble(
        rsqall = rsqall,
        rsqpre = rsqpre,
        rsqpos = rsqpos
      )
    })
  ) |>
  select(-data) |>
  unnest(model) |>
  pivot_longer(
    cols = starts_with('rsq'),
    names_to = 'period',
    values_to = 'rsq'
  ) |>
  mutate(
    lag = str_remove(lag, 'Lag '),
    period = case_when(
      period == 'rsqall' ~ '1995 to 2024',
      period == 'rsqpre' ~ 'Before 2010',
      period == 'rsqpos' ~ '2010 and After'
    ),
    period = factor(
      period,
      levels = c('1995 to 2024', 'Before 2010', '2010 and After')
    )
  )

rsqplo_fun(mod)
```

### Individual Lags

```{r}
tomodindotb <- tomodind |>
  filter(bay_segment %in% 'OTB')

# create scatterplots of chla vs tn_load with linear fits for each lag
pall <- lagplo_fun(tomodindotb, '1995 to 2024', '#F8766D')
ppre <- lagplo_fun(
  tomodindotb[tomodindotb$yrcat %in% 'Before 2010', ],
  'Before 2010',
  '#00BA38'
)
ppos <- lagplo_fun(
  tomodindotb[tomodindotb$yrcat %in% '2010 and After', ],
  '2010 and After',
  '#619CFF'
)

pall + ppre + ppos + plot_layout(ncol = 1, axis_titles = 'collect')
```

```{r}
mod <- tomodindotb |>
  group_nest(lag) |>
  mutate(
    model = map(data, function(x) {
      modall <- lm(
        chla ~ factor(mo) + tn_load,
        data = x
      )
      modpre <- lm(
        chla ~ factor(mo) + tn_load,
        data = x[x$yrcat == 'Before 2010', ]
      )
      modpos <- lm(
        chla ~ factor(mo) + tn_load,
        data = x[x$yrcat == '2010 and After', ]
      )

      # get rsq for all
      rsqall <- summary(modall)$r.squared
      rsqpre <- summary(modpre)$r.squared
      rsqpos <- summary(modpos)$r.squared

      tibble(
        rsqall = rsqall,
        rsqpre = rsqpre,
        rsqpos = rsqpos
      )
    })
  ) |>
  select(-data) |>
  unnest(model) |>
  pivot_longer(
    cols = starts_with('rsq'),
    names_to = 'period',
    values_to = 'rsq'
  ) |>
  mutate(
    lag = str_remove(lag, 'Lag '),
    period = case_when(
      period == 'rsqall' ~ '1995 to 2024',
      period == 'rsqpre' ~ 'Before 2010',
      period == 'rsqpos' ~ '2010 and After'
    ),
    period = factor(
      period,
      levels = c('1995 to 2024', 'Before 2010', '2010 and After')
    )
  )

rsqplo_fun(mod)
```

:::

## Assimilative Capacity Analysis

The cumulative lag model with a 3-month lag was chosen for the assimilative capacity analysis based on the results above and previous work by Janicki and Wade (1996). Separate models were used for the periods before and after 2010 to account for potential changes in factors driving chlorophyll-a concentration over time.

```{r}
toprdaddotb <- tomodaddotb |>
  pivot_wider(
    names_from = lag,
    values_from = tn_load
  ) |>
  group_nest(yrcat) |>
  mutate(
    model = map(data, function(x) {
      lm(
        chla ~ factor(mo) + `Lag 3`,
        data = x,
        na.action = 'na.exclude'
      )
    }),
    pred = map2(model, data, function(mod, dat) {
      predict(mod, newdata = dat)
    })
  )

toplo <- toprdaddotb |>
  select(-model) |>
  unnest(c(data, pred))

ggplot(toplo, aes(x = date, y = chla)) +
  geom_point() +
  geom_line(aes(y = pred, group = yrcat, color = yrcat)) +
  geom_hline(yintercept = 9.3, linetype = 'dashed', color = 'red') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Monthly Observed and Predicted Chlorophyll-a in Old Tampa Bay',
    y = 'µg/L',
    x = NULL,
    color = 'Model'
  )
```

The annual average observed and predicted chlorophyll-a concentrations are compared to the target of 9.3 µg/L for Old Tampa Bay below.

```{r}
annavg <- tbeptools::anlz_avedat(epcdata)$ann |>
  filter(bay_segment %in% 'OTB', var == 'mean_chla') |>
  filter(yr >= 1995) |>
  mutate(
    achieve = ifelse(val <= 9.3, 'Yes', 'No'),
  )

modestavg <- toplo |>
  summarize(
    predchla = mean(pred, na.rm = TRUE),
    .by = c(yr, yrcat)
  ) |>
  mutate(
    achieve = ifelse(predchla <= 9.3, 'Yes', 'No')
  )

ggplot(annavg, aes(x = yr, y = val)) +
  geom_line(aes(color = 'Observed')) +
  geom_point(aes(shape = achieve, color = 'Observed'), size = 3) +
  geom_line(data = modestavg, aes(x = yr, y = predchla, color = 'Predicted')) +
  geom_point(
    data = modestavg,
    aes(x = yr, y = predchla, shape = achieve, color = 'Predicted'),
    size = 3
  ) +
  geom_hline(yintercept = 9.3, linetype = 'dashed', color = 'red') +
  scale_shape_manual(values = c(16, 17)) +
  scale_color_manual(values = c('Observed' = 'black', 'Predicted' = 'blue')) +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  guides(color = guide_legend(override.aes = list(shape = NA))) +
  labs(
    title = 'Annual Average Observed and Predicted Chlorophyll-a in Old Tampa Bay',
    y = 'µg/L',
    x = 'Year',
    shape = 'Meets 9.3 µg/L Target',
    color = NULL
  )
```

The assimilative capacity analysis involves simulating various nitrogen load reduction scenarios and predicting the resulting chlorophyll-a concentrations using the developed models. Monthly loads are reduced by fractions ranging from 0% to 100% in 5% increments. The models are then used to predict chlorophyll-a concentrations under each load reduction scenario for both time periods (before and after 2010).

```{r}
# load reduction scenarios

redscn <- crossing(
  redscn = seq(0, 1, by = 0.05),
  lddat |>
    mutate(yrcat = ifelse(yr < 2010, 'Before 2010', '2010 and After')) |>
    filter(bay_segment %in% 'OTB')
) |>
  group_nest(redscn, yrcat) |>
  mutate(
    yrcat = factor(
      yrcat,
      levels = c('Before 2010', '2010 and After')
    ),
    data = pmap(list(redscn, data), function(red, dat) {
      dat |>
        mutate(
          tn_load_lag0 = tn_load * red,
          tn_load_lag1 = lag(tn_load_lag0, 1),
          tn_load_lag2 = lag(tn_load_lag0, 2),
          tn_load_lag3 = lag(tn_load_lag0, 3)
        ) |>
        mutate(
          tn_load_lag1 = rowSums(
            pick(tn_load_lag0:tn_load_lag1),
            na.rm = FALSE
          ),
          tn_load_lag2 = rowSums(
            pick(tn_load_lag0:tn_load_lag2),
            na.rm = FALSE
          ),
          tn_load_lag3 = rowSums(pick(tn_load_lag0:tn_load_lag3), na.rm = FALSE)
        ) |>
        rename(`Lag 3` = tn_load_lag3)
    }),
    data = map2(data, yrcat, function(dat, yrc) {
      mod <- toprdaddotb |> filter(yrcat == yrc) |> pull(model)
      prd <- predict(
        mod[[1]],
        newdata = dat,
      )
      bind_cols(dat, tibble(predchla = prd))
    }),
    annavg = map(data, function(dat) {
      dat |>
        summarize(
          tn_load = sum(tn_load_lag0, na.rm = TRUE),
          predchla = mean(predchla, na.rm = TRUE),
          .by = yr
        )
    })
  )

toplo <- redscn |>
  select(redscn, yrcat, data) |>
  unnest(data)

ggplot(toplo, aes(x = date, y = tn_load_lag0)) +
  geom_line(aes(group = redscn, color = redscn)) +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'D') +
  facet_wrap(~yrcat, ncol = 1, scales = 'free_x') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Monthly Load Reduction Scenarios',
    y = 'tons/month',
    x = NULL
  )

ggplot(toplo, aes(x = date, y = predchla)) +
  geom_line(aes(group = redscn, color = redscn)) +
  geom_hline(yintercept = 9.3, linetype = 'dashed', color = 'red') +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'C') +
  facet_wrap(~yrcat, ncol = 1, scales = 'free_x') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Monthly Predicted Chlorophyll-a Under Load Reduction Scenarios',
    y = 'µg/L',
    x = NULL
  )
```

Monthly  model predictions are then aggregated to annual average predicted chlorophyll-a and total nitrogen loads for each load reduction scenario.

```{r}
toplo2 <- redscn |>
  select(redscn, yrcat, annavg) |>
  unnest(annavg)

ggplot(toplo2, aes(x = yr, y = tn_load, group = redscn)) +
  geom_line(aes(color = redscn)) +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'D') +
  facet_wrap(~yrcat, ncol = 1, scales = 'free_x') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Annual Total Nitrogen Loads from Monthly Reduction Scenarios',
    y = 'tons/year',
    x = NULL
  )

ggplot(toplo2, aes(x = yr, y = predchla, group = redscn)) +
  geom_line(aes(color = redscn)) +
  geom_hline(yintercept = 9.3, linetype = 'dashed', color = 'red') +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'C') +
  facet_wrap(~yrcat, ncol = 1, scales = 'free_x') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Annual Average Predicted Chlorophyll-a Under Load Reduction Scenarios',
    y = 'µg/L',
    x = NULL
  )
```

The average response of chlorophyll-a to nitrogen load changes was then estimated for each time period by taking the average of the annual chlorophyll predictions and the average load estimates for each reduction scenario.  The plots below show each point as the average predicted chlorophyll-a versus the average total nitrogen load for each load reduction scenario.  The dashed red line indicates the target chlorophyll-a concentration of 9.3 µg/L.  The arrows indicate the estimated nitrogen load reductions needed to achieve the target chlorophyll-a concentration for each time period based on linear interpolation of the average response curves. The estimated loads needed to achieve 9.3 µg/L chlorophyll-a are 569 tons/year before 2010 and 645 tons/year for 2010 and after.

```{r}
toplo3 <- toplo2 |>
  summarise(
    avechl = mean(predchla, na.rm = TRUE),
    hichl = t.test(predchla)$conf.int[2],
    locl = t.test(predchla)$conf.int[1],
    tn_load = mean(tn_load, na.rm = TRUE),
    .by = c(redscn, yrcat)
  )

# get the x-axis load values for 9.3 ug/L chl-a
befass <- lm(
  avechl ~ tn_load,
  data = toplo3[toplo3$yrcat %in% 'Before 2010', ]
) |>
  coefficients()
aftass <- lm(
  avechl ~ tn_load,
  data = toplo3[toplo3$yrcat %in% '2010 and After', ]
) |>
  coefficients()
befass <- (9.3 - befass[1]) / befass[2]
aftass <- (9.3 - aftass[1]) / aftass[2]

addlns <- tibble(
  avechl = 9.3,
  yrcat = factor(
    c('Before 2010', '2010 and After'),
    levels = c('Before 2010', '2010 and After')
  ),
  tn_load = c(befass, aftass)
)

ggplot(toplo3, aes(x = tn_load, y = avechl)) +
  geom_line(aes(color = yrcat)) +
  geom_point(aes(color = yrcat)) +
  geom_segment(
    data = addlns,
    aes(
      x = tn_load,
      y = avechl,
      xend = tn_load,
      yend = 0,
      color = yrcat
    ),
    arrow = arrow(length = unit(0.6, "cm")),
    linetype = 'solid',
  ) +
  geom_text(
    data = addlns,
    aes(
      x = tn_load,
      y = 0,
      label = paste0(
        'Estimated load at 9.3 µg/L: ',
        round(tn_load, 0),
        ' tons/yr'
      ),
      color = yrcat
    ),
    hjust = 1.05,
    vjust = 0,
    size = 3,
    fontface = 'bold'
  ) +
  geom_ribbon(
    aes(
      ymin = locl,
      ymax = hichl,
      fill = yrcat
    ),
    alpha = 0.2,
    color = NA
  ) +
  geom_hline(yintercept = 9.3, linetype = 'dashed', color = 'red') +
  facet_wrap(~yrcat) +
  theme_minimal() +
  theme(
    legend.position = 'none'
  ) +
  labs(
    title = 'Average Predicted Chlorophyll-a vs. Average Nitrogen\nLoad Under Load Reduction Scenarios',
    y = 'µg/L',
    x = 'tons/yr',
  )
```

## Model Improvements

The above models used to predict the assimilative capacity of Old Tampa Bay, particularly for the period after 2010, likely provide an overestimate of how much loading the bay segment can assimilate.  This is evident by evaluating the residual patterns - the model does not capture extreme values.  Results could be improved by modeling an inherently log-normal response variable and including additional predictors to provide a more accurate estimate of how nitrogen load influences chlorophyll-a.

```{r}
aftmod <- toprdaddotb$model[[1]]
ggplot(data.frame(residuals = residuals(aftmod)), aes(sample = residuals)) +
  stat_qq() +
  stat_qq_line(color = 'red') +
  labs(
    title = "Normal Q-Q Plot of Residuals from Post-2010 OTB Model",
    x = "Theoretical Quantiles",
    y = "Sample Quantiles"
  ) +
  theme_minimal()
```

To address this issue, an additional model was developed using log-transformed chlorophyll-a as the response variable and additional predictors, including salinity and temperature. 

```{r}
newdat <- epcdata |>
  filter(
    bay_segment %in% 'OTB'
  ) |>
  mutate(
    date = make_date(yr, mo, day = 1)
  ) |>
  summarise(
    sal = mean(Sal_Top_ppth, na.rm = T),
    temp = mean(Temp_Water_Top_degC, na.rm = T),
    .by = c(bay_segment, date, yr, mo)
  ) |>
  left_join(wqmo, by = c('bay_segment', 'date', 'yr', 'mo')) |>
  inner_join(lddat, by = c('bay_segment', 'date', 'yr', 'mo')) |>
  arrange(date)

toplo <- newdat |>
  select(chla, sal, temp, tn_load) |>
  mutate(
    chla = log10(chla),
    tn_load = log10(1 + tn_load)
  )

ggpairs(toplo)
```

Collinearity among the new predictors was assessed using variance inflation factors (VIFs).  The values are sufficiently low to include all predictors in the model.

```{r}
# check vif
source(
  'https://gist.githubusercontent.com/fawda123/4717702/raw/b5ccabd6966376552257940f9bad7bd344b49c49/vif_fun.r'
)
vif_func(toplo[, names(toplo) != 'chla'])
```

```{r}
# create up to six month lags for tn_load
newtomod <- newdat |>
  mutate(
    tn_load_lag1 = lag(tn_load, 1),
    tn_load_lag2 = lag(tn_load, 2),
    tn_load_lag3 = lag(tn_load, 3),
    tn_load_lag4 = lag(tn_load, 4),
    tn_load_lag5 = lag(tn_load, 5),
    tn_load_lag6 = lag(tn_load, 6),
    yrcat = ifelse(yr < 2010, 'Before 2010', '2010 and After'),
    .by = bay_segment
  ) |>
  rename(tn_load_lag0 = tn_load) |>
  mutate(
    tn_load_lag1 = rowSums(pick(tn_load_lag0:tn_load_lag1), na.rm = FALSE),
    tn_load_lag2 = rowSums(pick(tn_load_lag0:tn_load_lag2), na.rm = FALSE),
    tn_load_lag3 = rowSums(pick(tn_load_lag0:tn_load_lag3), na.rm = FALSE),
    tn_load_lag4 = rowSums(pick(tn_load_lag0:tn_load_lag4), na.rm = FALSE),
    tn_load_lag5 = rowSums(pick(tn_load_lag0:tn_load_lag5), na.rm = FALSE),
    tn_load_lag6 = rowSums(pick(tn_load_lag0:tn_load_lag6), na.rm = FALSE)
  ) |>
  pivot_longer(
    cols = starts_with('tn_load_lag'),
    names_to = 'lag',
    values_to = 'tn_load'
  ) |>
  mutate(
    lag = str_remove(lag, 'tn_load_'),
    lag = str_replace(lag, 'lag', 'Lag ')
  )

mod <- newtomod |>
  group_nest(lag) |>
  mutate(
    model = map(data, function(x) {
      modall <- lm(
        log10(chla) ~ factor(mo) + log10(1 + tn_load) + sal + temp,
        data = x
      )
      modpre <- lm(
        log10(chla) ~ factor(mo) + log10(1 + tn_load) + sal + temp,
        data = x[x$yrcat == 'Before 2010', ]
      )
      modpos <- lm(
        log10(chla) ~ factor(mo) + log10(1 + tn_load) + sal + temp,
        data = x[x$yrcat == '2010 and After', ]
      )

      # get rsq for all
      rsqall <- summary(modall)$r.squared
      rsqpre <- summary(modpre)$r.squared
      rsqpos <- summary(modpos)$r.squared

      tibble(
        rsqall = rsqall,
        rsqpre = rsqpre,
        rsqpos = rsqpos
      )
    })
  ) |>
  select(-data) |>
  unnest(model) |>
  pivot_longer(
    cols = starts_with('rsq'),
    names_to = 'period',
    values_to = 'rsq'
  ) |>
  mutate(
    lag = str_remove(lag, 'Lag '),
    period = case_when(
      period == 'rsqall' ~ '1995 to 2024',
      period == 'rsqpre' ~ 'Before 2010',
      period == 'rsqpos' ~ '2010 and After'
    ),
    period = factor(
      period,
      levels = c('1995 to 2024', 'Before 2010', '2010 and After')
    )
  )

rsqplo_fun(mod, ylim = c(0.4, 0.76))
```

```{r}
newtoprd <- newtomod |>
  pivot_wider(
    names_from = lag,
    values_from = tn_load
  ) |>
  group_nest(yrcat) |>
  mutate(
    model = map(data, function(x) {
      lm(
        log10(chla) ~ factor(mo) + log10(1 + `Lag 3`) + sal + temp,
        ,
        data = x,
        na.action = 'na.exclude'
      )
    }),
    pred = map2(model, data, function(mod, dat) {
      10^predict(mod, newdata = dat)
    })
  )

toplo <- newtoprd |>
  select(-model) |>
  unnest(c(data, pred))

ggplot(toplo, aes(x = date, y = chla)) +
  geom_point() +
  geom_line(aes(y = pred, group = yrcat, color = yrcat)) +
  # geom_hline(yintercept = 9.3, linetype = 'dashed', color = 'red') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Monthly Observed and Predicted Chlorophyll-a in Old Tampa Bay',
    y = 'µg/L',
    x = NULL,
    color = 'Model'
  )
```

The annual average observed and predicted chlorophyll-a concentrations are compared to the target of 9.3 µg/L for Old Tampa Bay below.

```{r}
annavg <- tbeptools::anlz_avedat(epcdata)$ann |>
  filter(bay_segment %in% 'OTB', var == 'mean_chla') |>
  filter(yr >= 1995) |>
  mutate(
    achieve = ifelse(val <= 9.3, 'Yes', 'No'),
  )

modestavg <- toplo |>
  summarize(
    predchla = mean(pred, na.rm = TRUE),
    .by = c(yr, yrcat)
  ) |>
  mutate(
    achieve = ifelse(predchla <= 9.3, 'Yes', 'No')
  )

ggplot(annavg, aes(x = yr, y = val)) +
  geom_line(aes(color = 'Observed')) +
  geom_point(aes(shape = achieve, color = 'Observed'), size = 3) +
  geom_line(data = modestavg, aes(x = yr, y = predchla, color = 'Predicted')) +
  geom_point(
    data = modestavg,
    aes(x = yr, y = predchla, shape = achieve, color = 'Predicted'),
    size = 3
  ) +
  geom_hline(yintercept = 9.3, linetype = 'dashed', color = 'red') +
  scale_shape_manual(values = c(16, 17)) +
  scale_color_manual(values = c('Observed' = 'black', 'Predicted' = 'blue')) +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  guides(color = guide_legend(override.aes = list(shape = NA))) +
  labs(
    title = 'Annual Average Observed and Predicted Chlorophyll-a in Old Tampa Bay',
    y = 'µg/L',
    x = 'Year',
    shape = 'Meets 9.3 µg/L Target',
    color = NULL
  )
```

```{r}
redscn <- crossing(
  redscn = seq(0, 1, by = 0.05),
  newdat |>
    mutate(yrcat = ifelse(yr < 2010, 'Before 2010', '2010 and After'))
) |>
  group_nest(redscn, yrcat) |>
  mutate(
    yrcat = factor(
      yrcat,
      levels = c('Before 2010', '2010 and After')
    ),
    data = pmap(list(redscn, data), function(red, dat) {
      dat |>
        mutate(
          tn_load_lag0 = tn_load * red,
          tn_load_lag1 = lag(tn_load_lag0, 1),
          tn_load_lag2 = lag(tn_load_lag0, 2),
          tn_load_lag3 = lag(tn_load_lag0, 3)
        ) |>
        mutate(
          tn_load_lag1 = rowSums(
            pick(tn_load_lag0:tn_load_lag1),
            na.rm = FALSE
          ),
          tn_load_lag2 = rowSums(
            pick(tn_load_lag0:tn_load_lag2),
            na.rm = FALSE
          ),
          tn_load_lag3 = rowSums(pick(tn_load_lag0:tn_load_lag3), na.rm = FALSE)
        ) |>
        rename(`Lag 3` = tn_load_lag3)
    }),
    data = map2(data, yrcat, function(dat, yrc) {
      mod <- newtoprd |> filter(yrcat == yrc) |> pull(model)
      prd <- predict(
        mod[[1]],
        newdata = dat,
      )
      bind_cols(dat, tibble(predchla = 10^prd))
    }),
    annavg = map(data, function(dat) {
      dat |>
        summarize(
          tn_load = sum(tn_load_lag0, na.rm = TRUE),
          predchla = mean(predchla, na.rm = TRUE),
          .by = yr
        )
    })
  )

toplo <- redscn |>
  select(redscn, yrcat, data) |>
  unnest(data)

ggplot(toplo, aes(x = date, y = tn_load_lag0)) +
  geom_line(aes(group = redscn, color = redscn)) +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'D') +
  facet_wrap(~yrcat, ncol = 1, scales = 'free_x') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Monthly Load Reduction Scenarios',
    y = 'tons/month',
    x = NULL
  )

ggplot(toplo, aes(x = date, y = predchla)) +
  geom_line(aes(group = redscn, color = redscn)) +
  geom_hline(yintercept = 9.3, linetype = 'dashed', color = 'red') +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'C') +
  facet_wrap(~yrcat, ncol = 1, scales = 'free_x') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Monthly Predicted Chlorophyll-a Under Load Reduction Scenarios',
    y = 'µg/L',
    x = NULL
  )
```

Monthly  model predictions are then aggregated to annual average predicted chlorophyll-a and total nitrogen loads for each load reduction scenario.

```{r}
toplo2 <- redscn |>
  select(redscn, yrcat, annavg) |>
  unnest(annavg)

ggplot(toplo2, aes(x = yr, y = tn_load, group = redscn)) +
  geom_line(aes(color = redscn)) +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'D') +
  facet_wrap(~yrcat, ncol = 1, scales = 'free_x') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Annual Total Nitrogen Loads from Monthly Reduction Scenarios',
    y = 'tons/year',
    x = NULL
  )

ggplot(toplo2, aes(x = yr, y = predchla, group = redscn)) +
  geom_line(aes(color = redscn)) +
  geom_hline(yintercept = 9.3, linetype = 'dashed', color = 'red') +
  scale_color_viridis_c(name = 'Load Reduction\nFraction', option = 'C') +
  facet_wrap(~yrcat, ncol = 1, scales = 'free_x') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Annual Average Predicted Chlorophyll-a Under Load Reduction Scenarios',
    y = 'µg/L',
    x = NULL
  )
```

Figure out better way for load reductions to work...