---
title: "Exploring the Assimilative Capacity of Old Tampa Bay"
author: "Tampa Bay Estuary Program"
date: "`r Sys.Date()`"
format:
  html:
    theme: cosmo
    code-tools: 
      source: https://github.com/tbep-tech/explore-ass-cap/blob/main/docs/explore.qmd
    css: styles.css
toc: true
lightbox: true
execute:
  echo: false
  warning: false
---

```{r}
#| include: false
library(sf)
library(tidyverse)
library(here)
library(reactable)
library(reactablefmtr)
library(leaflet)
library(patchwork)

source(here('R/funcs.R'))

data(epcdata, package = 'tbeptools')
load(file = here('data/lddat.RData'))

# bay segment chl aves
wqmo <- tbeptools::anlz_avedat(epcdata)$mos |>
  filter(var == 'mean_chla') |>
  rename(chla = val) |>
  select(-var) |>
  mutate(
    date = make_date(yr, mo, day = 1)
  )

# join and create up to five month lags for tn_load
tomod <- inner_join(wqmo, lddat, by = c('bay_segment', 'date', 'yr', 'mo')) |>
  mutate(
    tn_load_lag1 = lag(tn_load, 1),
    tn_load_lag2 = lag(tn_load, 2),
    tn_load_lag3 = lag(tn_load, 3),
    tn_load_lag4 = lag(tn_load, 4),
    tn_load_lag5 = lag(tn_load, 5),
    tn_load_lag6 = lag(tn_load, 6),
    yrcat = ifelse(yr < 2010, 'Before 2010', '2010 and After'),
    .by = bay_segment
  ) |>
  rename(tn_load_lag0 = tn_load)

tomodadd <- tomod |>
  mutate(
    tn_load_lag1 = rowSums(pick(tn_load_lag0:tn_load_lag1), na.rm = FALSE),
    tn_load_lag2 = rowSums(pick(tn_load_lag0:tn_load_lag2), na.rm = FALSE),
    tn_load_lag3 = rowSums(pick(tn_load_lag0:tn_load_lag3), na.rm = FALSE),
    tn_load_lag4 = rowSums(pick(tn_load_lag0:tn_load_lag4), na.rm = FALSE),
    tn_load_lag5 = rowSums(pick(tn_load_lag0:tn_load_lag5), na.rm = FALSE),
    tn_load_lag6 = rowSums(pick(tn_load_lag0:tn_load_lag6), na.rm = FALSE)
  ) |>
  pivot_longer(
    cols = starts_with('tn_load_lag'),
    names_to = 'lag',
    values_to = 'tn_load'
  ) |>
  mutate(
    lag = str_remove(lag, 'tn_load_'),
    lag = str_replace(lag, 'lag', 'Lag ')
  )

tomodind <- tomod |>
  pivot_longer(
    cols = starts_with('tn_load_lag'),
    names_to = 'lag',
    values_to = 'tn_load'
  ) |>
  mutate(
    lag = str_remove(lag, 'tn_load_'),
    lag = str_replace(lag, 'lag', 'Lag ')
  )
```

## Original Model, All Bay Segments 

The cumulative lag model from [Janicki and Wade 1996](https://drive.google.com/file/d/1kZkvuprvsMyN9nPS5PHYvXHyo1KQxKTr/view) is specified as:

$$
\text{chla}_{t, s} = \alpha_{t, s} + \beta_s \left( \Sigma_{t = 0}^{n} L_{t, s} \right)
$$

where $\text{chla}_{t, s}$ is the chlorophyll-a concentration at month $t$ and bay segment $s$, $\alpha_{t, s}$ is the intercept term that varies by $t$ and $s$, $\beta_s$ is the coefficient for the cumulative load term that varies by $s$, and $L_{t, s}$ is the cumulative nitrogen nitrogen load evaluated at different lags from 0 to $n$ months for each $s$.

The individaul lag model is specified as:
$$
\text{chla}_{t, s} = \alpha_{t, s} + \beta_s L_{n, s}
$$

where $\text{chla}_{t, s}$ is the chlorophyll-a concentration at month $t$ and bay segment $s$, $\alpha_{t, s}$ is the intercept term that varies by $t$ and $s$, $\beta_s$ is the coefficient for the individual load term that varies by $s$, and $L_{t, s}$ is the individual nitrogen load evaluated at different monthly $n$ lags for each $s$.

Both models are run with the following linear model structure in  R, where the `tn_load` variable is either the cumulative or individual lag load for different $n$ lags.

```{r}
#| eval: false
#| echo: true
chla ~ 0 + factor(bay_segment):factor(mo) + tn_load:factor(bay_segment)
```

::: {.panel-tabset}

### Cumulative Lags

```{r}
# create scatterplots of chla vs tn_load with linear fits for each lag
pall <- lagplo_fun(tomodadd, '1995 to 2024', '#F8766D')
ppre <- lagplo_fun(
  tomodadd[tomodadd$yrcat %in% 'Before 2010', ],
  'Before 2010',
  '#00BA38'
)
ppos <- lagplo_fun(
  tomodadd[tomodadd$yrcat %in% '2010 and After', ],
  '2010 and After',
  '#619CFF'
)

pall + ppre + ppos + plot_layout(ncol = 1, axis_titles = 'collect')
```

```{r}
mod <- tomodadd |>
  group_nest(lag) |>
  mutate(
    model = map(data, function(x) {
      modall <- lm(
        chla ~ 0 + factor(bay_segment):factor(mo) + tn_load:factor(bay_segment),
        data = x
      )
      modpre <- lm(
        chla ~ 0 + factor(bay_segment):factor(mo) + tn_load:factor(bay_segment),
        data = x[x$yrcat == 'Before 2010', ]
      )
      modpos <- lm(
        chla ~ 0 + factor(bay_segment):factor(mo) + tn_load:factor(bay_segment),
        data = x[x$yrcat == '2010 and After', ]
      )

      # get rsq for all
      rsqall <- summary(modall)$r.squared
      rsqpre <- summary(modpre)$r.squared
      rsqpos <- summary(modpos)$r.squared

      tibble(
        rsqall = rsqall,
        rsqpre = rsqpre,
        rsqpos = rsqpos
      )
    })
  ) |>
  select(-data) |>
  unnest(model) |>
  pivot_longer(
    cols = starts_with('rsq'),
    names_to = 'period',
    values_to = 'rsq'
  ) |>
  mutate(
    lag = str_remove(lag, 'Lag '),
    period = case_when(
      period == 'rsqall' ~ '1995 to 2024',
      period == 'rsqpre' ~ 'Before 2010',
      period == 'rsqpos' ~ '2010 and After'
    ),
    period = factor(
      period,
      levels = c('1995 to 2024', 'Before 2010', '2010 and After')
    )
  )

rsqplo_fun(mod)
```

### Individual Lags

```{r}
# create scatterplots of chla vs tn_load with linear fits for each lag
pall <- lagplo_fun(tomodind, '1995 to 2024', '#F8766D')
ppre <- lagplo_fun(
  tomodind[tomodind$yrcat %in% 'Before 2010', ],
  'Before 2010',
  '#00BA38'
)
ppos <- lagplo_fun(
  tomodind[tomodind$yrcat %in% '2010 and After', ],
  '2010 and After',
  '#619CFF'
)

pall + ppre + ppos + plot_layout(ncol = 1, axis_titles = 'collect')
```

```{r}
mod <- tomodind |>
  group_nest(lag) |>
  mutate(
    model = map(data, function(x) {
      modall <- lm(
        chla ~ 0 + factor(bay_segment):factor(mo) + tn_load:factor(bay_segment),
        data = x
      )
      modpre <- lm(
        chla ~ 0 + factor(bay_segment):factor(mo) + tn_load:factor(bay_segment),
        data = x[x$yrcat == 'Before 2010', ]
      )
      modpos <- lm(
        chla ~ 0 + factor(bay_segment):factor(mo) + tn_load:factor(bay_segment),
        data = x[x$yrcat == '2010 and After', ]
      )

      # get rsq for all
      rsqall <- summary(modall)$r.squared
      rsqpre <- summary(modpre)$r.squared
      rsqpos <- summary(modpos)$r.squared

      tibble(
        rsqall = rsqall,
        rsqpre = rsqpre,
        rsqpos = rsqpos
      )
    })
  ) |>
  select(-data) |>
  unnest(model) |>
  pivot_longer(
    cols = starts_with('rsq'),
    names_to = 'period',
    values_to = 'rsq'
  ) |>
  mutate(
    lag = str_remove(lag, 'Lag '),
    period = case_when(
      period == 'rsqall' ~ '1995 to 2024',
      period == 'rsqpre' ~ 'Before 2010',
      period == 'rsqpos' ~ '2010 and After'
    ),
    period = factor(
      period,
      levels = c('1995 to 2024', 'Before 2010', '2010 and After')
    )
  )

rsqplo_fun(mod)
```

:::

## OTB Only Model

The models are the same as above except the bay segment term is removed since only OTB is being modeled.

The cumulative lag model from is specified as:

$$
\text{chla}_{t} = \alpha_{t} + \beta \left( \Sigma_{t = 0}^{n} L_{t} \right)
$$

where $\text{chla}_{t}$ is the chlorophyll-a concentration at month $t$, $\alpha_{t}$ is the intercept term that varies by $t$, $\beta$ is the coefficient for the cumulative load term, and $L_{t}$ is the cumulative nitrogen load evaluated at different lags from 0 to $n$ months.

The individaul lag model is specified as:
$$
\text{chla}_{t, s} = \alpha_{t, s} + \beta_s L_{n, s}
$$

where $\text{chla}_{t}$ is the chlorophyll-a concentration at month $t$, $\alpha_{t}$ is the intercept term that varies by $t$, $\beta$ is the coefficient for the individual load term, and $L_{t}$ is the individual nitrogen load evaluated at different monthly $n$ lags.

Both models are run with the following linear model structure in  R, where the `tn_load` variable is either the cumulative or individual lag load for different $n$ lags.

```{r}
#| eval: false
#| echo: true
chla ~ 0 + factor(mo) + tn_load
```

::: {.panel-tabset}

### Cumulative Lags

```{r}
tomodaddotb <- tomodadd |>
  filter(bay_segment %in% 'OTB')

# create scatterplots of chla vs tn_load with linear fits for each lag
pall <- lagplo_fun(tomodaddotb, '1995 to 2024', '#F8766D')
ppre <- lagplo_fun(
  tomodaddotb[tomodaddotb$yrcat %in% 'Before 2010', ],
  'Before 2010',
  '#00BA38'
)
ppos <- lagplo_fun(
  tomodaddotb[tomodaddotb$yrcat %in% '2010 and After', ],
  '2010 and After',
  '#619CFF'
)

pall + ppre + ppos + plot_layout(ncol = 1, axis_titles = 'collect')
```

```{r}
mod <- tomodaddotb |>
  group_nest(lag) |>
  mutate(
    model = map(data, function(x) {
      modall <- lm(
        chla ~ 0 + factor(mo) + tn_load,
        data = x
      )
      modpre <- lm(
        chla ~ 0 + factor(mo) + tn_load,
        data = x[x$yrcat == 'Before 2010', ]
      )
      modpos <- lm(
        chla ~ 0 + factor(mo) + tn_load,
        data = x[x$yrcat == '2010 and After', ]
      )

      # get rsq for all
      rsqall <- summary(modall)$r.squared
      rsqpre <- summary(modpre)$r.squared
      rsqpos <- summary(modpos)$r.squared

      tibble(
        rsqall = rsqall,
        rsqpre = rsqpre,
        rsqpos = rsqpos
      )
    })
  ) |>
  select(-data) |>
  unnest(model) |>
  pivot_longer(
    cols = starts_with('rsq'),
    names_to = 'period',
    values_to = 'rsq'
  ) |>
  mutate(
    lag = str_remove(lag, 'Lag '),
    period = case_when(
      period == 'rsqall' ~ '1995 to 2024',
      period == 'rsqpre' ~ 'Before 2010',
      period == 'rsqpos' ~ '2010 and After'
    ),
    period = factor(
      period,
      levels = c('1995 to 2024', 'Before 2010', '2010 and After')
    )
  )

rsqplo_fun(mod)
```

### Individual Lags

```{r}
tomodindotb <- tomodind |>
  filter(bay_segment %in% 'OTB')

# create scatterplots of chla vs tn_load with linear fits for each lag
pall <- lagplo_fun(tomodindotb, '1995 to 2024', '#F8766D')
ppre <- lagplo_fun(
  tomodindotb[tomodindotb$yrcat %in% 'Before 2010', ],
  'Before 2010',
  '#00BA38'
)
ppos <- lagplo_fun(
  tomodindotb[tomodindotb$yrcat %in% '2010 and After', ],
  '2010 and After',
  '#619CFF'
)

pall + ppre + ppos + plot_layout(ncol = 1, axis_titles = 'collect')
```

```{r}
mod <- tomodindotb |>
  group_nest(lag) |>
  mutate(
    model = map(data, function(x) {
      modall <- lm(
        chla ~ 0 + factor(mo) + tn_load,
        data = x
      )
      modpre <- lm(
        chla ~ 0 + factor(mo) + tn_load,
        data = x[x$yrcat == 'Before 2010', ]
      )
      modpos <- lm(
        chla ~ 0 + factor(mo) + tn_load,
        data = x[x$yrcat == '2010 and After', ]
      )

      # get rsq for all
      rsqall <- summary(modall)$r.squared
      rsqpre <- summary(modpre)$r.squared
      rsqpos <- summary(modpos)$r.squared

      tibble(
        rsqall = rsqall,
        rsqpre = rsqpre,
        rsqpos = rsqpos
      )
    })
  ) |>
  select(-data) |>
  unnest(model) |>
  pivot_longer(
    cols = starts_with('rsq'),
    names_to = 'period',
    values_to = 'rsq'
  ) |>
  mutate(
    lag = str_remove(lag, 'Lag '),
    period = case_when(
      period == 'rsqall' ~ '1995 to 2024',
      period == 'rsqpre' ~ 'Before 2010',
      period == 'rsqpos' ~ '2010 and After'
    ),
    period = factor(
      period,
      levels = c('1995 to 2024', 'Before 2010', '2010 and After')
    )
  )

rsqplo_fun(mod)
```

:::

## Cumulative Lagged Model to Predict 9.3 $\mu$g/L Chl-a Threshold

```{r}
toprdaddotb <- tomodaddotb |>
  pivot_wider(
    names_from = lag,
    values_from = tn_load
  ) |>
  group_nest(yrcat) |>
  mutate(
    model = map(data, function(x) {
      lm(
        chla ~ 0 + factor(mo) + `Lag 3`,
        data = x,
        na.action = 'na.exclude'
      )
    }),
    pred = map2(model, data, function(mod, dat) {
      predict(mod, newdata = dat)
    })
  )

toplo <- toprdaddotb |>
  select(-model) |>
  unnest(c(data, pred))

ggplot(toplo, aes(x = date, y = chla)) +
  geom_point() +
  geom_line(aes(y = pred, group = yrcat, color = yrcat)) +
  geom_hline(yintercept = 9.3, linetype = 'dashed', color = 'red') +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  labs(
    title = 'Observed and Predicted Chlorophyll-a in Old Tampa Bay',
    y = 'Chlorophyll-a (µg/L)',
    x = NULL,
    color = 'Period'
  )
```

```{r}
annavg <- tbeptools::anlz_avedat(epcdata)$ann |>
  filter(bay_segment %in% 'OTB', var == 'mean_chla') |>
  filter(yr >= 1995) |>
  mutate(
    achieve = ifelse(val <= 9.3, 'Yes', 'No'),
  )

modestavg <- toplo |>
  summarize(
    predchla = mean(pred, na.rm = TRUE),
    .by = c(yr, yrcat)
  ) |>
  mutate(
    achieve = ifelse(predchla <= 9.3, 'Yes', 'No')
  )

ggplot(annavg, aes(x = yr, y = val)) +
  geom_line(aes(color = 'Observed')) +
  geom_point(aes(shape = achieve, color = 'Observed'), size = 3) +
  geom_line(data = modestavg, aes(x = yr, y = predchla, color = 'Predicted')) +
  geom_point(
    data = modestavg,
    aes(x = yr, y = predchla, shape = achieve, color = 'Predicted'),
    size = 3
  ) +
  geom_hline(yintercept = 9.3, linetype = 'dashed', color = 'red') +
  scale_shape_manual(values = c(16, 17)) +
  scale_color_manual(values = c('Observed' = 'black', 'Predicted' = 'blue')) +
  theme_minimal() +
  theme(
    legend.position = 'bottom'
  ) +
  guides(color = guide_legend(override.aes = list(shape = NA))) +
  labs(
    title = 'Annual Average Observed and Predicted Chlorophyll-a in Old Tampa Bay',
    y = 'Annual Average Chlorophyll-a (µg/L)',
    x = 'Year',
    shape = 'Meets 9.3 µg/L Target',
    color = NULL
  )
```